{% extends "base.html" %}

{% block title %}Test Overview - EU Trip Tracker{% endblock %}

{% block extra_head %}
<style>
    /* Test Overview Specific Styles */
    .test-overview-container {
        background: #FAF9F6; /* Whisper White */
        min-height: 100vh;
        padding: 24px;
    }
    
    .test-header {
        background: white;
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .test-header h1 {
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        font-size: 28px;
        font-weight: 600;
        color: #1f2937;
        margin: 0 0 8px 0;
    }
    
    .test-header p {
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        color: #6b7280;
        margin: 0;
        font-size: 14px;
    }
    
    .test-summary {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .test-summary .summary-line {
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        font-size: 14px;
        color: #059669;
        font-weight: 500;
        margin-bottom: 12px;
    }
    
    .test-actions {
        display: flex;
        gap: 12px;
        align-items: center;
    }
    
    .btn-reload {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .btn-reload:hover {
        background: #2563eb;
    }
    
    .btn-reload:disabled {
        background: #9ca3af;
        cursor: not-allowed;
    }
    
    .btn-back {
        background: #6b7280;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        display: inline-block;
        transition: background 0.2s;
    }
    
    .btn-back:hover {
        background: #4b5563;
    }
    
    .test-table-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .test-table {
        width: 100%;
        border-collapse: collapse;
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }
    
    .test-table thead {
        background: #f3f4f6;
    }
    
    .test-table th {
        text-align: left;
        padding: 12px 16px;
        font-weight: 600;
        color: #374151;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .test-table tbody tr {
        border-bottom: 1px solid #e5e7eb;
        transition: background 0.15s;
    }
    
    .test-table tbody tr:nth-child(even) {
        background: #fafafa;
    }
    
    .test-table tbody tr:hover {
        background: #f9fafb;
    }
    
    .test-table td {
        padding: 12px 16px;
        color: #1f2937;
        font-size: 14px;
    }
    
    .test-table td.employee-name {
        font-weight: 500;
        color: #111827;
    }
    
    .test-table td.status-cell {
        font-weight: 600;
    }
    
    /* Status color classes */
    .status-safe {
        background-color: #d9fdd3;
        color: #166534;
    }
    
    .status-warning {
        background-color: #fff3cd;
        color: #92400e;
    }
    
    .status-danger {
        background-color: #f8d7da;
        color: #991b1b;
    }
    
    .no-data-message {
        text-align: center;
        padding: 60px 20px;
        color: #6b7280;
        font-size: 16px;
    }
    
    .error-message {
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 24px;
        color: #991b1b;
        font-size: 14px;
    }
    
    .reload-status {
        font-size: 13px;
        color: #059669;
        margin-left: 12px;
        font-weight: 500;
    }
    
    .reload-status.error {
        color: #dc2626;
    }
</style>
{% endblock %}

{% block content %}
<div class="test-overview-container">
    <!-- Header -->
    <div class="test-header">
        <h1>üß™ Test Overview - Import Verification</h1>
        <p>Verify that Excel imports and 90/180-day calculations are working correctly</p>
        <p style="font-size: 12px; color: #9ca3af; margin-top: 8px;">
            <strong>Note:</strong> This is a temporary testing page. Ireland trips are excluded from 90-day calculations.
        </p>
    </div>
    
    <!-- Error Message -->
    {% if error %}
    <div class="error-message">
        <strong>Error:</strong> {{ error }}
    </div>
    {% endif %}
    
    <!-- Summary -->
    <div class="test-summary">
        {% if total_employees > 0 %}
        <div class="summary-line">
            ‚úÖ Data loaded successfully ‚Äî <strong>{{ total_employees }}</strong> employees, <strong>{{ total_trips }}</strong> trips total
            {% if last_import %}
                (last import: <strong>{{ last_import.strftime('%d-%m-%Y %H:%M') }}</strong>)
            {% endif %}
        </div>
        {% if excel_file %}
        <div style="font-size: 12px; color: #6b7280; margin-bottom: 16px;">
            üìÑ Source file: <strong>{{ excel_file }}</strong>
        </div>
        {% endif %}
        {% else %}
        <div class="summary-line" style="color: #dc2626;">
            ‚ö†Ô∏è No data found ‚Äî Excel file missing or no valid trips imported
        </div>
        {% endif %}
        
        <!-- Actions -->
        <div class="test-actions">
            <button id="reloadBtn" class="btn-reload" onclick="reloadExcelData()">
                üîÑ Reload Excel Data
            </button>
            <a href="{{ url_for('main.dashboard') }}" class="btn-back">
                ‚Üê Back to Dashboard
            </a>
            <span id="reloadStatus" class="reload-status" style="display: none;"></span>
        </div>
    </div>
    
    <!-- Data Table -->
    {% if employees %}
    <div class="test-table-container">
        <table class="test-table">
            <thead>
                <tr>
                    <th>Employee Name</th>
                    <th>Current/Recent Country</th>
                    <th>Total Trips</th>
                    <th>Days Used (90-day)</th>
                    <th>Days Left</th>
                    <th>Status</th>
                    <th>Next Eligible Entry</th>
                    <th>Last Exit Date</th>
                </tr>
            </thead>
            <tbody>
                {% for emp in employees %}
                <tr>
                    <td class="employee-name">{{ emp.name }}</td>
                    <td>{{ emp.current_country }}</td>
                    <td>{{ emp.total_trips }}</td>
                    <td>{{ emp.days_used }} / 90</td>
                    <td>{{ emp.days_remaining }}</td>
                    <td class="status-cell status-{{ emp.status }}">
                        {{ emp.status_emoji }} 
                        {% if emp.status == 'safe' %}Safe
                        {% elif emp.status == 'warning' %}Warning
                        {% else %}Exceeded
                        {% endif %}
                    </td>
                    <td>{{ emp.next_eligible }}</td>
                    <td>{{ emp.last_exit }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="test-table-container">
        <div class="no-data-message">
            <p style="font-size: 48px; margin: 0 0 16px 0;">üì≠</p>
            <p><strong>No employee data found</strong></p>
            <p style="font-size: 14px; margin-top: 8px;">
                Upload an Excel file via the <a href="{{ url_for('main.import_excel') }}" style="color: #3b82f6;">Import Data</a> page to get started.
            </p>
        </div>
    </div>
    {% endif %}
    
    <!-- Timestamp -->
    <div style="text-align: center; margin-top: 24px; color: #9ca3af; font-size: 12px;">
        Page loaded at: {{ load_time.strftime('%d-%m-%Y %H:%M:%S') }}
    </div>
</div>

<script>
    function reloadExcelData() {
        const btn = document.getElementById('reloadBtn');
        const status = document.getElementById('reloadStatus');
        
        // Disable button and show loading
        btn.disabled = true;
        btn.textContent = '‚è≥ Reloading...';
        status.style.display = 'inline';
        status.className = 'reload-status';
        status.textContent = 'Processing Excel file...';
        
        // Call reload endpoint
        fetch('{{ url_for("test_overview.test_overview_reload") }}')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    status.textContent = `‚úÖ Success! Added ${data.trips_added} trips, skipped ${data.duplicates_skipped} duplicates`;
                    
                    // Reload page after 2 seconds
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    status.className = 'reload-status error';
                    status.textContent = `‚ùå Error: ${data.error}`;
                    btn.disabled = false;
                    btn.textContent = 'üîÑ Reload Excel Data';
                }
            })
            .catch(error => {
                status.className = 'reload-status error';
                status.textContent = `‚ùå Error: ${error.message}`;
                btn.disabled = false;
                btn.textContent = 'üîÑ Reload Excel Data';
            });
    }
</script>
{% endblock %}


