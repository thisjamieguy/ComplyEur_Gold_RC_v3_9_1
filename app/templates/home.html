{% extends "base.html" %}

{% block title %}Home - EU Trip Tracker{% endblock %}
{% block meta_description %}Welcome to ComplyEur. View travel compliance overview, EU travel news, and manage your team's travel compliance.{% endblock %}

{% block content %}
<div class="content-header">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
        <div>
            <h1 class="content-title">Welcome{{ ', ' + admin_name if admin_name != 'Admin' else '' }} ðŸ‘‹</h1>
            <p class="content-subtitle">Welcome back to EU Tracker</p>
        </div>
        <!-- News Filter Toggle (Admin Only) -->
        {% if session.get('is_admin') %}
        <div style="display: flex; align-items: center; gap: 12px; background: white; padding: 12px 16px; border-radius: 8px; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <span style="font-size: 14px; font-weight: 500; color: #374151;">News Filter:</span>
            <div style="display: flex; align-items: center; gap: 8px;">
                <button onclick="toggleNewsFilter('EU_ONLY')" 
                        class="news-filter-btn {{ 'active' if config.get('NEWS_FILTER_REGION', 'EU_ONLY') == 'EU_ONLY' else '' }}"
                        style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 6px; background: white; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
                    EU Only
                </button>
                <button onclick="toggleNewsFilter('ALL')" 
                        class="news-filter-btn {{ 'active' if config.get('NEWS_FILTER_REGION', 'EU_ONLY') == 'ALL' else '' }}"
                        style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 6px; background: white; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
                    All Regions
                </button>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div class="content-body">
    <!-- Quick Info Cards -->
    <div class="row mb-4" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 24px;">
        <!-- Active Employees -->
        <div class="card" style="background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="padding: 24px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                    <div style="width: 48px; height: 48px; background: rgba(37, 99, 235, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #2563eb;">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="8.5" cy="7" r="4"></circle>
                            <path d="M20 8v6M23 11h-6"></path>
                        </svg>
                    </div>
                </div>
                <div style="font-size: 32px; font-weight: 700; color: #1e40af; margin-bottom: 4px;">{{ total_employees }}</div>
                <div style="font-size: 14px; color: #1e40af; opacity: 0.8;">Active Employees</div>
            </div>
        </div>

        <!-- Trips This Month -->
        <div class="card" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="padding: 24px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                    <div style="width: 48px; height: 48px; background: rgba(16, 185, 129, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #10b981;">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                    </div>
                </div>
                <div style="font-size: 32px; font-weight: 700; color: #065f46; margin-bottom: 4px;">{{ trips_this_month }}</div>
                <div style="font-size: 14px; color: #065f46; opacity: 0.8;">Trips Logged This Month</div>
            </div>
        </div>

        <!-- At Risk -->
        <div class="card" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="padding: 24px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                    <div style="width: 48px; height: 48px; background: rgba(239, 68, 68, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #ef4444;">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                            <line x1="12" y1="9" x2="12" y2="13"></line>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                    </div>
                </div>
                <div style="font-size: 32px; font-weight: 700; color: #991b1b; margin-bottom: 4px;">{{ at_risk_count }}</div>
                <div style="font-size: 14px; color: #991b1b; opacity: 0.8;">At Risk of 90-Day Limit</div>
            </div>
        </div>
    </div>

    <!-- EU Travel News Section -->
    <div class="card" style="margin-top: 24px; background: var(--base-bg); border: 1px solid #e5e7eb; border-radius: 12px;">
        <div class="card-header" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); padding: 20px; border-bottom: 1px solid #e5e7eb; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="color: #1e40af; margin: 0; display: flex; align-items: center; gap: 12px; font-size: 20px; font-weight: 600;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                    <line x1="8" y1="7" x2="16" y2="7"></line>
                    <line x1="8" y1="11" x2="16" y2="11"></line>
                </svg>
                Latest EU Travel News & Advisories
            </h2>
            <button onclick="refreshNews()" id="refreshNewsBtn" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                <svg id="refreshIcon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <polyline points="1 20 1 14 7 14"></polyline>
                    <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                </svg>
                <span id="refreshText">Refresh</span>
            </button>
        </div>
        <div class="card-body" style="padding: 20px;">
            {% if news_items %}
            <div style="display: flex; flex-direction: column; gap: 16px;">
                {% for item in news_items %}
                <div style="padding: 16px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; transition: all 0.2s; border-left: 4px solid #3b82f6;" 
                     onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)'"
                     onmouseout="this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                    <div style="display: flex; align-items: start; justify-content: space-between; gap: 12px;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">
                                    {{ item.source_name }}
                                </span>
                                {% if item.published_at %}
                                <span style="font-size: 12px; color: #9ca3af;">
                                    â€¢ {{ item.published_at.strftime('%d-%m-%Y') }}
                                </span>
                                {% endif %}
                                {% if item.matched_label %}
                                <span class="badge" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                                    {{ item.matched_label }}
                                </span>
                                {% endif %}
                            </div>
                            <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600; color: #1f2937;">
                                <a href="{{ item.url }}" target="_blank" rel="noopener noreferrer" 
                                   style="color: #1f2937; text-decoration: none; display: inline-flex; align-items: center; gap: 6px;">
                                    {{ item.title }}
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity: 0.6;">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                </a>
                            </h3>
                            {% if item.summary %}
                            <p style="margin: 0; font-size: 14px; color: #6b7280; line-height: 1.5;">
                                {{ item.summary }}
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div style="text-align: center; padding: 40px 20px; color: #6b7280;">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity: 0.3; margin-bottom: 16px;">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                    <line x1="8" y1="7" x2="16" y2="7"></line>
                    <line x1="8" y1="11" x2="16" y2="11"></line>
                </svg>
                <p style="font-size: 14px; margin: 0;">No recent news available</p>
            </div>
            {% endif %}
            
            <div style="margin-top: 24px; padding: 12px 16px; background: #f9fafb; border-radius: 6px; border-left: 4px solid #93c5fd;">
                <p style="margin: 0; font-size: 12px; color: #6b7280; line-height: 1.5;">
                    {% if news_items %}
                    <strong>Note:</strong> News content is sourced from public sector information feeds. 
                    {% endif %}
                    For GOV.UK content: Contains public-sector information licensed under the Open Government Licence v3.0.
                </p>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    transition: transform 0.2s, box-shadow 0.2s;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
}

.nav-item {
    transition: background-color 0.2s;
}

.news-filter-btn.active {
    background: #3b82f6 !important;
    color: white !important;
    border-color: #3b82f6 !important;
}

.news-filter-btn:hover:not(.active) {
    background: #f9fafb;
    border-color: #9ca3af;
}
</style>

<script>
function toggleNewsFilter(region) {
    // Update button states
    document.querySelectorAll('.news-filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Send AJAX request to update setting
    fetch('{{ url_for("main.admin_settings") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `news_filter_region=${region}`
    })
    .then(response => {
        if (response.ok) {
            // Reload the page to show updated news
            window.location.reload();
        } else {
            console.error('Failed to update news filter');
        }
    })
    .catch(error => {
        console.error('Error updating news filter:', error);
    });
}

function refreshNews() {
    const btn = document.getElementById('refreshNewsBtn');
    const icon = document.getElementById('refreshIcon');
    const text = document.getElementById('refreshText');
    
    // Disable button and show loading state
    btn.disabled = true;
    btn.style.background = '#9ca3af';
    text.textContent = 'Refreshing...';
    icon.style.animation = 'spin 1s linear infinite';
    
    // Add CSS for spinning animation
    if (!document.getElementById('spinStyle')) {
        const style = document.createElement('style');
        style.id = 'spinStyle';
        style.textContent = '@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }';
        document.head.appendChild(style);
    }
    
    // Send refresh request
    fetch('/api/news/refresh', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            text.textContent = 'Refreshed!';
            setTimeout(() => {
                // Reload page to show new news
                window.location.reload();
            }, 1000);
        } else {
            throw new Error(data.message || 'Refresh failed');
        }
    })
    .catch(error => {
        console.error('Error refreshing news:', error);
        text.textContent = 'Error';
        btn.style.background = '#ef4444';
        setTimeout(() => {
            btn.disabled = false;
            btn.style.background = '#3b82f6';
            text.textContent = 'Refresh';
            icon.style.animation = '';
        }, 2000);
    });
}
</script>
{% endblock %}
