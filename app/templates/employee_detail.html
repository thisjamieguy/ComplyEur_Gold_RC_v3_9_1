{% extends "base.html" %}

{% block title %}{{ employee.name }} - EU Trip Tracker{% endblock %}

{% block content %}
<div class="content-header">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
        <div>
            <h1 class="content-title">{{ employee.name }}</h1>
            <p class="content-subtitle">Employee trip history and compliance tracking</p>
        </div>
        <div style="display: flex; gap: 12px;">
            <a href="{{ url_for('main.calendar', employee_id=employee.id) }}" class="btn btn-secondary">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                Calendar View
            </a>
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9,22 9,12 15,12 15,22"></polyline>
                </svg>
                Back to Dashboard
            </a>
        </div>
    </div>
</div>

<div class="content-body">
    <!-- Status Alert -->
    {% if days_used >= 90 %}
    <div class="card" style="border-left: 4px solid #ef4444; background: #fef2f2;">
        <div style="padding: 12px;">
            <h3 style="color: #991b1b; font-weight: 600; margin: 0 0 4px 0;">Over 90-Day Limit</h3>
                <p style="color: #991b1b; margin: 0;">
                    This employee has used {{ days_used }} days in the last 180 days, exceeding the 90-day limit.
                    {% if days_until_safe %}
                    They will be compliant again in {{ days_until_safe }} days.
                    {% endif %}
                </p>
        </div>
    </div>
    {% elif days_used > 80 %}
    <div class="card" style="border-left: 4px solid #f59e0b; background: #fffbeb;">
        <div style="padding: 12px;">
            <h3 style="color: #92400e; font-weight: 600; margin: 0 0 4px 0;">Approaching Limit</h3>
            <p style="color: #92400e; margin: 0;">
                This employee has used {{ days_used }} days in the last 180 days. Only {{ 90 - days_used }} days remaining.
            </p>
        </div>
    </div>
    {% endif %}

    <!-- Summary Stats -->
    <div class="grid grid-3">
        <div class="card text-center">
            <div style="font-size: 36px; font-weight: 700; color: {% if risk_level == 'red' %}#ef4444{% elif risk_level == 'amber' %}#f59e0b{% else %}#10b981{% endif %}; margin-bottom: 8px;">
                {{ days_used }}
            </div>
            <div class="text-muted" style="font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                Days Used (180d)
            </div>
            <div style="margin-top: 12px; background: #e5e7eb; height: 10px; border-radius: 5px; overflow: hidden;">
                <div style="height: 100%; width: {{ (days_used / 90 * 100)|round }}%; background: {% if risk_level == 'red' %}#ef4444{% elif risk_level == 'amber' %}#f59e0b{% else %}#10b981{% endif %}; transition: all 0.3s;"></div>
            </div>
        </div>
        
        <div class="card text-center">
            <div style="font-size: 36px; font-weight: 700; color: {% if risk_level == 'red' %}#ef4444{% elif risk_level == 'amber' %}#f59e0b{% else %}#10b981{% endif %}; margin-bottom: 8px;">
                {{ days_remaining }}
            </div>
            <div class="text-muted" style="font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                Days Remaining
            </div>
            <div style="margin-top: 12px; font-size: 14px; color: #6b7280;">
                {% if risk_level == 'red' %}
                    <span style="color: #ef4444; font-weight: 600;">High Risk</span>
                {% elif risk_level == 'amber' %}
                    <span style="color: #f59e0b; font-weight: 600;">Caution</span>
                {% else %}
                    <span style="color: #10b981; font-weight: 600;">Safe</span>
                {% endif %}
            </div>
        </div>
        
        <div class="card text-center">
            {% if earliest_safe_entry %}
                <div style="font-size: 28px; font-weight: 700; color: #f59e0b; margin-bottom: 8px;">
                    {{ earliest_safe_entry }}
                </div>
                <div class="text-muted" style="font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                    Earliest Safe Entry
                </div>
                <div style="margin-top: 12px; font-size: 14px; color: #6b7280;">
                    {% if days_until_safe %}
                        In {{ days_until_safe }} days
                    {% endif %}
                </div>
            {% else %}
                <div style="font-size: 28px; font-weight: 700; color: #10b981; margin-bottom: 8px;">
                    Eligible
                </div>
                <div class="text-muted" style="font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                    Can Enter Now
                </div>
                <div style="margin-top: 12px; font-size: 14px; color: #10b981; font-weight: 600;">
                    Available
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Add Trip Form -->
    <div class="card" id="trip-warnings">
        <div class="card-header">
            <h2 class="card-title">Add New Trip</h2>
        </div>
        
        {% if session.get('pending_trip') and session.pending_trip.employee_id|int == employee.id %}
        <div style="background: #fffbeb; border-left: 4px solid #f59e0b; padding: 16px; margin: 16px; border-radius: 4px;">
            <div style="padding: 12px;">
                <h3 style="color: #92400e; font-weight: 600; margin: 0 0 8px 0;">Trip Validation Warnings</h3>
                    <ul style="margin: 0 0 12px 20px; color: #92400e;">
                        {% for warning in session.pending_trip.warnings %}
                        <li>{{ warning }}</li>
                        {% endfor %}
                    </ul>
                    <p style="color: #92400e; margin: 0 0 12px 0;">
                        You can override these warnings by providing a reason and clicking "Add Trip Anyway".
                    </p>
                    <form method="POST" action="{{ url_for('main.add_trip') }}" style="display: flex; gap: 12px; align-items: end;">
                        <input type="hidden" name="employee_id" value="{{ employee.id }}">
                        <input type="hidden" name="country_code" value="{{ session.pending_trip.country_code }}">
                        <input type="hidden" name="entry_date" value="{{ session.pending_trip.entry_date }}">
                        <input type="hidden" name="exit_date" value="{{ session.pending_trip.exit_date }}">
                        <input type="hidden" name="override_validation" value="true">
                        <div style="flex: 1;">
                            <label style="display: block; font-size: 13px; color: #92400e; margin-bottom: 4px;">Override Reason:</label>
                            <input type="text" name="validation_note" class="form-input" placeholder="e.g., Emergency travel, Business critical" required style="width: 100%;">
                        </div>
                        <button type="submit" class="btn" style="background: #f59e0b; color: white;">Add Trip Anyway</button>
                        <a href="{{ url_for('main.employee_detail', employee_id=employee.id) }}" class="btn btn-outline">Cancel</a>
                    </form>
            </div>
        </div>
        {% endif %}
        
        <form method="POST" action="{{ url_for('main.add_trip') }}">
            <input type="hidden" name="employee_id" value="{{ employee.id }}">
            
            <div class="form-inline">
                <div class="form-group">
                    <label class="form-label">Country</label>
                    <div class="dropdown-container">
                        <input type="text" name="country_display" class="form-input dropdown-input" placeholder="Select country" required readonly onclick="toggleDropdown('countryDropdown')">
                        <div class="dropdown-arrow">â–¼</div>
                        <div id="countryDropdown" class="dropdown-list">
                            <div class="dropdown-item" onclick="selectCountry('Austria', 'AT')">ğŸ‡¦ğŸ‡¹ Austria (AT)</div>
                            <div class="dropdown-item" onclick="selectCountry('Belgium', 'BE')">ğŸ‡§ğŸ‡ª Belgium (BE)</div>
                            <div class="dropdown-item" onclick="selectCountry('Bulgaria', 'BG')">ğŸ‡§ğŸ‡¬ Bulgaria (BG)</div>
                            <div class="dropdown-item" onclick="selectCountry('Croatia', 'HR')">ğŸ‡­ğŸ‡· Croatia (HR)</div>
                            <div class="dropdown-item" onclick="selectCountry('Cyprus', 'CY')">ğŸ‡¨ğŸ‡¾ Cyprus (CY)</div>
                            <div class="dropdown-item" onclick="selectCountry('Czech Republic', 'CZ')">ğŸ‡¨ğŸ‡¿ Czech Republic (CZ)</div>
                            <div class="dropdown-item" onclick="selectCountry('Denmark', 'DK')">ğŸ‡©ğŸ‡° Denmark (DK)</div>
                            <div class="dropdown-item" onclick="selectCountry('Estonia', 'EE')">ğŸ‡ªğŸ‡ª Estonia (EE)</div>
                            <div class="dropdown-item" onclick="selectCountry('Finland', 'FI')">ğŸ‡«ğŸ‡® Finland (FI)</div>
                            <div class="dropdown-item" onclick="selectCountry('France', 'FR')">ğŸ‡«ğŸ‡· France (FR)</div>
                            <div class="dropdown-item" onclick="selectCountry('Germany', 'DE')">ğŸ‡©ğŸ‡ª Germany (DE)</div>
                            <div class="dropdown-item" onclick="selectCountry('Greece', 'GR')">ğŸ‡¬ğŸ‡· Greece (GR)</div>
                            <div class="dropdown-item" onclick="selectCountry('Hungary', 'HU')">ğŸ‡­ğŸ‡º Hungary (HU)</div>
                            <div class="dropdown-item" onclick="selectCountry('Iceland', 'IS')">ğŸ‡®ğŸ‡¸ Iceland (IS)</div>
                            <div class="dropdown-item" onclick="selectCountry('Ireland', 'IE')">ğŸ‡®ğŸ‡ª Ireland (IE)</div>
                            <div class="dropdown-item" onclick="selectCountry('Italy', 'IT')">ğŸ‡®ğŸ‡¹ Italy (IT)</div>
                            <div class="dropdown-item" onclick="selectCountry('Latvia', 'LV')">ğŸ‡±ğŸ‡» Latvia (LV)</div>
                            <div class="dropdown-item" onclick="selectCountry('Liechtenstein', 'LI')">ğŸ‡±ğŸ‡® Liechtenstein (LI)</div>
                            <div class="dropdown-item" onclick="selectCountry('Lithuania', 'LT')">ğŸ‡±ğŸ‡¹ Lithuania (LT)</div>
                            <div class="dropdown-item" onclick="selectCountry('Luxembourg', 'LU')">ğŸ‡±ğŸ‡º Luxembourg (LU)</div>
                            <div class="dropdown-item" onclick="selectCountry('Malta', 'MT')">ğŸ‡²ğŸ‡¹ Malta (MT)</div>
                            <div class="dropdown-item" onclick="selectCountry('Netherlands', 'NL')">ğŸ‡³ğŸ‡± Netherlands (NL)</div>
                            <div class="dropdown-item" onclick="selectCountry('Norway', 'NO')">ğŸ‡³ğŸ‡´ Norway (NO)</div>
                            <div class="dropdown-item" onclick="selectCountry('Poland', 'PL')">ğŸ‡µğŸ‡± Poland (PL)</div>
                            <div class="dropdown-item" onclick="selectCountry('Portugal', 'PT')">ğŸ‡µğŸ‡¹ Portugal (PT)</div>
                            <div class="dropdown-item" onclick="selectCountry('Romania', 'RO')">ğŸ‡·ğŸ‡´ Romania (RO)</div>
                            <div class="dropdown-item" onclick="selectCountry('Slovakia', 'SK')">ğŸ‡¸ğŸ‡° Slovakia (SK)</div>
                            <div class="dropdown-item" onclick="selectCountry('Slovenia', 'SI')">ğŸ‡¸ğŸ‡® Slovenia (SI)</div>
                            <div class="dropdown-item" onclick="selectCountry('Spain', 'ES')">ğŸ‡ªğŸ‡¸ Spain (ES)</div>
                            <div class="dropdown-item" onclick="selectCountry('Sweden', 'SE')">ğŸ‡¸ğŸ‡ª Sweden (SE)</div>
                            <div class="dropdown-item" onclick="selectCountry('Switzerland', 'CH')">ğŸ‡¨ğŸ‡­ Switzerland (CH)</div>
                        </div>
                    </div>
                </div>
                <input type="hidden" name="country_code" id="country_code" value="">
                
                <div class="form-group">
                    <label class="form-label">Entry Date</label>
                    <input type="date" name="entry_date" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Exit Date</label>
                    <input type="date" name="exit_date" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn btn-primary" style="margin-top: 24px;">Add Trip</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Trip Planning Tool -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Trip Planning Tool</h2>
        </div>
        <p class="text-muted" style="margin-bottom: 20px;">
            Plan a future trip to see how it would affect your 90-day limit without adding it to your record.
        </p>
        
        <div class="form-inline">
            <div class="form-group">
                <label class="form-label">Planned Country</label>
                <input type="text" id="planCountry" class="form-input" placeholder="Enter country">
            </div>
            <div class="form-group">
                <label class="form-label">Entry Date</label>
                <input type="date" id="planEntryDate" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Exit Date</label>
                <input type="date" id="planExitDate" class="form-input">
            </div>
            <div class="form-group">
                <button onclick="planTrip()" class="btn btn-outline" style="margin-top: 24px;">Plan Trip</button>
            </div>
        </div>
        
        <div id="tripPlanResult" style="display: none; margin-top: 20px;"></div>
    </div>

    <!-- Trip History -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Trip History</h2>
        </div>
        
        {% if trips %}
        <div class="table-container">
            <table class="table" id="tripHistoryTable">
                <thead>
                    <tr>
                        <th>Country</th>
                        <th class="sortable" onclick="sortTripTable('entry_date')" data-tooltip="Click to sort by entry date">
                            Entry Date <span class="sort-arrow" id="entryDateArrow">â–¼</span>
                        </th>
                        <th class="sortable" onclick="sortTripTable('exit_date')" data-tooltip="Click to sort by exit date">
                            Exit Date <span class="sort-arrow" id="exitDateArrow">â–¼</span>
                        </th>
                        <th>Duration</th>
                        <th>Status</th>
                        <th>Days Remaining</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tripTableBody">
                    {% for trip in trips %}
                    <tr data-trip-id="{{ trip.id }}">
                        <td style="font-weight: 500;">
                            {{ trip.country }}
                            {% if trip.country|is_ireland %}
                                <br><small style="color: #9ca3af; font-size: 11px;">(Non-Schengen)</small>
                            {% endif %}
                            {% if trip.validation_note %}
                                <br><small style="color: #f59e0b; font-size: 11px;" title="Validation override: {{ trip.validation_note }}">Override</small>
                            {% endif %}
                        </td>
                        <td>{{ trip.entry_date }}</td>
                        <td>{{ trip.exit_date }}</td>
                        <td>
                            {{ trip.duration }} day{% if trip.duration != 1 %}s{% endif %}
                            {% if trip.travel_days and trip.travel_days > 0 %}
                                <br><small class="text-muted">({{ trip.travel_days }} travel day{% if trip.travel_days != 1 %}s{% endif %})</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if trip.status == 'completed' %}
                                <span class="status-badge status-safe">Completed</span>
                            {% elif trip.status == 'current' %}
                                <span class="status-badge status-warning">Current</span>
                            {% else %}
                                <span class="status-badge" style="background: #f0f9ff; color: #1e40af;">Future</span>
                                {% if trip.forecast %}
                                    <br>
                                    <span class="forecast-risk-badge" style="display: inline-block; margin-top: 6px; padding: 4px 10px; border-radius: 10px; font-size: 11px; font-weight: 600; {% if trip.forecast.risk_level == 'red' %}background: #c53030; color: white;{% elif trip.forecast.risk_level == 'yellow' %}background: #ca8a04; color: white;{% else %}background: #16a34a; color: white;{% endif %}" title="Days at job start: {{ trip.forecast.days_after_job }} / 90">
                                        {% if trip.forecast.risk_level == 'red' %}
                                            ğŸ”´ {{ trip.forecast.days_after_job }}/90
                                        {% elif trip.forecast.risk_level == 'yellow' %}
                                            ğŸŸ¡ {{ trip.forecast.days_after_job }}/90
                                        {% else %}
                                            ğŸŸ¢ {{ trip.forecast.days_after_job }}/90
                                        {% endif %}
                                    </span>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td>
                            <span class="days-remaining-badge" style="
                                display: inline-block; 
                                padding: 6px 12px; 
                                border-radius: 12px; 
                                font-size: 12px; 
                                font-weight: 600;
                                {% if trip.risk_level_after == 'green' %}
                                    background: #d1fae5; color: #065f46;
                                {% elif trip.risk_level_after == 'amber' %}
                                    background: #fef3c7; color: #92400e;
                                {% else %}
                                    background: #fee2e2; color: #991b1b;
                                {% endif %}
                            ">
                                {{ trip.days_remaining_after }} days
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="openEditModal({{ trip.id }})" style="margin-right: 8px;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                                Edit
                            </button>
                            <form method="POST" action="{{ url_for('main.delete_trip', trip_id=trip.id) }}" style="display: inline;">
                                <input type="hidden" name="employee_id" value="{{ employee.id }}">
                                <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this trip?')">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3,6 5,6 21,6"></polyline>
                                        <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"></path>
                                    </svg>
                                    Delete
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% if trip.validation_note %}
                    <tr class="validation-note-row" data-parent-trip="{{ trip.id }}">
                        <td colspan="7" style="background: #fffbeb; padding: 8px 16px; border-left: 4px solid #f59e0b;">
                            <small style="color: #92400e;">
                                <strong>Override Reason:</strong> {{ trip.validation_note }}
                            </small>
                        </td>
                    </tr>
                    {% endif %}
                    {% if trip.status == 'future' and trip.forecast and not trip.forecast.is_compliant %}
                    <tr class="forecast-details-row" data-parent-trip="{{ trip.id }}">
                        <td colspan="7" style="background: {% if trip.forecast.risk_level == 'red' %}#fee{% elif trip.forecast.risk_level == 'yellow' %}#fefce8{% else %}#f0fdf4{% endif %}; padding: 12px 16px; border-left: 4px solid {% if trip.forecast.risk_level == 'red' %}#c53030{% elif trip.forecast.risk_level == 'yellow' %}#ca8a04{% else %}#16a34a{% endif %};">
                            <div style="color: {% if trip.forecast.risk_level == 'red' %}#742a2a{% elif trip.forecast.risk_level == 'yellow' %}#713f12{% else %}#14532d{% endif %};">
                                <strong>âš ï¸ Compliance Warning:</strong> This trip would result in {{ trip.forecast.days_after_job }} days used (limit: 90 days).
                                {% if trip.forecast.compliant_from_date %}
                                <br><strong>Employee will be compliant again from:</strong> {{ trip.forecast.compliant_from_date.strftime('%B %d, %Y') }}
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center" style="padding: 40px;">
            <h3 style="color: #1f2937; font-weight: 600; margin-bottom: 8px;">No Trips Yet</h3>
            <p class="text-muted">Add the first trip using the form above</p>
        </div>
        {% endif %}
    </div>

    <!-- Edit Trip Modal -->
    <div id="editTripModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Trip</h3>
            </div>
            <form id="editTripForm">
                <input type="hidden" id="edit_trip_id" name="trip_id">
                
                <div class="form-group">
                    <label class="form-label">Country</label>
                    <select id="edit_country" name="country" class="form-input" required>
                        <option value="AT">ğŸ‡¦ğŸ‡¹ Austria</option>
                        <option value="BE">ğŸ‡§ğŸ‡ª Belgium</option>
                        <option value="BG">ğŸ‡§ğŸ‡¬ Bulgaria</option>
                        <option value="HR">ğŸ‡­ğŸ‡· Croatia</option>
                        <option value="CY">ğŸ‡¨ğŸ‡¾ Cyprus</option>
                        <option value="CZ">ğŸ‡¨ğŸ‡¿ Czech Republic</option>
                        <option value="DK">ğŸ‡©ğŸ‡° Denmark</option>
                        <option value="EE">ğŸ‡ªğŸ‡ª Estonia</option>
                        <option value="FI">ğŸ‡«ğŸ‡® Finland</option>
                        <option value="FR">ğŸ‡«ğŸ‡· France</option>
                        <option value="DE">ğŸ‡©ğŸ‡ª Germany</option>
                        <option value="GR">ğŸ‡¬ğŸ‡· Greece</option>
                        <option value="HU">ğŸ‡­ğŸ‡º Hungary</option>
                        <option value="IS">ğŸ‡®ğŸ‡¸ Iceland</option>
                        <option value="IE">ğŸ‡®ğŸ‡ª Ireland</option>
                        <option value="IT">ğŸ‡®ğŸ‡¹ Italy</option>
                        <option value="LV">ğŸ‡±ğŸ‡» Latvia</option>
                        <option value="LI">ğŸ‡±ğŸ‡® Liechtenstein</option>
                        <option value="LT">ğŸ‡±ğŸ‡¹ Lithuania</option>
                        <option value="LU">ğŸ‡±ğŸ‡º Luxembourg</option>
                        <option value="MT">ğŸ‡²ğŸ‡¹ Malta</option>
                        <option value="NL">ğŸ‡³ğŸ‡± Netherlands</option>
                        <option value="NO">ğŸ‡³ğŸ‡´ Norway</option>
                        <option value="PL">ğŸ‡µğŸ‡± Poland</option>
                        <option value="PT">ğŸ‡µğŸ‡¹ Portugal</option>
                        <option value="RO">ğŸ‡·ğŸ‡´ Romania</option>
                        <option value="SK">ğŸ‡¸ğŸ‡° Slovakia</option>
                        <option value="SI">ğŸ‡¸ğŸ‡® Slovenia</option>
                        <option value="ES">ğŸ‡ªğŸ‡¸ Spain</option>
                        <option value="SE">ğŸ‡¸ğŸ‡ª Sweden</option>
                        <option value="CH">ğŸ‡¨ğŸ‡­ Switzerland</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Entry Date</label>
                    <input type="date" id="edit_entry_date" name="entry_date" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Exit Date</label>
                    <input type="date" id="edit_exit_date" name="exit_date" class="form-input" required>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeModal('editTripModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Trip Table Sorting Functionality
let currentSortColumn = localStorage.getItem('tripTableSortColumn') || 'entry_date';
let currentSortDirection = localStorage.getItem('tripTableSortDirection') || 'asc';

function parseDDMMYYYY(dateStr) {
    // Parse DD-MM-YYYY format to a comparable Date object
    const parts = dateStr.split('-');
    if (parts.length !== 3) return new Date(0);
    const day = parseInt(parts[0], 10);
    const month = parseInt(parts[1], 10) - 1; // Months are 0-indexed
    const year = parseInt(parts[2], 10);
    return new Date(year, month, day);
}

function sortTripTable(column) {
    const tbody = document.getElementById('tripTableBody');
    const tripRows = Array.from(tbody.querySelectorAll('tr[data-trip-id]'));
    
    // Toggle sort direction if clicking the same column
    if (currentSortColumn === column) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        currentSortColumn = column;
        currentSortDirection = 'asc';
    }
    
    // Save sort state to localStorage
    localStorage.setItem('tripTableSortColumn', currentSortColumn);
    localStorage.setItem('tripTableSortDirection', currentSortDirection);
    
    // Get column index for sorting
    const columnIndex = column === 'entry_date' ? 1 : 2;
    
    // Sort the trip rows
    tripRows.sort((a, b) => {
        const aCell = a.cells[columnIndex];
        const bCell = b.cells[columnIndex];
        
        if (!aCell || !bCell) return 0;
        
        const aText = aCell.textContent.trim();
        const bText = bCell.textContent.trim();
        
        const aDate = parseDDMMYYYY(aText);
        const bDate = parseDDMMYYYY(bText);
        
        if (currentSortDirection === 'asc') {
            return aDate - bDate;
        } else {
            return bDate - aDate;
        }
    });
    
    // Update arrow indicators
    document.querySelectorAll('.sort-arrow').forEach(arrow => {
        arrow.classList.remove('active');
        arrow.textContent = 'â–¼';
    });
    
    const activeHeader = document.querySelector(`th[onclick="sortTripTable('${column}')"]`);
    const activeArrow = activeHeader.querySelector('.sort-arrow');
    activeArrow.classList.add('active');
    activeArrow.textContent = currentSortDirection === 'asc' ? 'â–²' : 'â–¼';
    
    // Fade out effect
    tbody.style.opacity = '0.3';
    tbody.style.transition = 'opacity 0.2s ease';
    
    // Reorder rows with animation
    setTimeout(() => {
        // Clear tbody
        tbody.innerHTML = '';
        
        // Re-append sorted rows with their associated validation notes
        tripRows.forEach(tripRow => {
            const tripId = tripRow.getAttribute('data-trip-id');
            tbody.appendChild(tripRow);
            
            // Find and append any validation note row that belongs to this trip
            const validationRow = document.querySelector(`.validation-note-row[data-parent-trip="${tripId}"]`);
            if (validationRow) {
                tbody.appendChild(validationRow);
            }
        });
        
        // Fade back in
        tbody.style.opacity = '1';
    }, 200);
}

// Initialize table with saved sort on page load
document.addEventListener('DOMContentLoaded', function() {
    // Give the page a moment to fully render, then apply saved sort
    setTimeout(() => {
        // First, reset all arrows to inactive state
        document.querySelectorAll('.sort-arrow').forEach(arrow => {
            arrow.classList.remove('active');
            arrow.textContent = 'â–¼';
        });
        
        // Then apply the saved sort which will update the correct arrow
        sortTripTable(currentSortColumn);
    }, 100);
});

// Country dropdown functionality
function toggleDropdown(dropdownId) {
    const dropdown = document.getElementById(dropdownId);
    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
}

function selectCountry(country, code) {
    document.querySelector('input[name="country_display"]').value = country;
    document.getElementById('country_code').value = code;
    document.getElementById('countryDropdown').style.display = 'none';
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.dropdown-container')) {
        document.getElementById('countryDropdown').style.display = 'none';
    }
});

// Trip planning functionality
function planTrip() {
    const country = document.getElementById('planCountry').value;
    const entryDate = document.getElementById('planEntryDate').value;
    const exitDate = document.getElementById('planExitDate').value;
    
    if (!country || !entryDate || !exitDate) {
        alert('Please fill in all fields');
        return;
    }
    
    if (new Date(exitDate) <= new Date(entryDate)) {
        alert('Exit date must be after entry date');
        return;
    }
    
    // Calculate trip duration
    const entry = new Date(entryDate);
    const exit = new Date(exitDate);
    const duration = Math.ceil((exit - entry) / (1000 * 60 * 60 * 24)) + 1;
    
    // Send request to forecast endpoint
    fetch('/forecast-trip', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            employee_id: {{ employee.id }},
            country: country,
            entry_date: entryDate,
            exit_date: exitDate
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }
        
        const resultDiv = document.getElementById('tripPlanResult');
        resultDiv.style.display = 'block';
        
        let statusClass = '';
        if (data.status === 'over_limit') {
            statusClass = 'status-danger';
        } else if (data.status === 'warning') {
            statusClass = 'status-warning';
        } else {
            statusClass = 'status-safe';
        }
        
        resultDiv.innerHTML = `
            <div class="card ${statusClass}" style="padding: 20px;">
                <h3 style="margin: 0 0 12px 0;">Trip Forecast</h3>
                <p style="margin: 0 0 12px 0; font-weight: 500;">${data.message}</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-top: 16px;">
                    <div>
                        <div style="font-size: 24px; font-weight: 700; color: #6b7280;">${data.current_days_used}</div>
                        <div style="font-size: 12px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Current Days</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: 700; color: #6b7280;">${duration}</div>
                        <div style="font-size: 12px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Trip Duration</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: 700; color: #6b7280;">${data.total_days_after}</div>
                        <div style="font-size: 12px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Total After Trip</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: 700; color: #6b7280;">${data.remaining_days}</div>
                        <div style="font-size: 12px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Days Remaining</div>
                    </div>
                </div>
            </div>
        `;
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while planning the trip');
    });
}

// Set default dates for trip planning
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    const nextWeek = new Date(today);
    nextWeek.setDate(nextWeek.getDate() + 7);
    
    document.getElementById('planEntryDate').value = tomorrow.toISOString().split('T')[0];
    document.getElementById('planExitDate').value = nextWeek.toISOString().split('T')[0];
});

// Edit Trip Modal functionality
function openEditModal(tripId) {
    fetch(`/get_trip/${tripId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error loading trip data: ' + data.error);
                return;
            }
            
            document.getElementById('edit_trip_id').value = data.id;
            document.getElementById('edit_country').value = data.country;
            document.getElementById('edit_entry_date').value = data.entry_date;
            document.getElementById('edit_exit_date').value = data.exit_date;
            
            openModal('editTripModal');
        })
        .catch(err => {
            console.error('Error:', err);
            alert('Error loading trip data');
        });
}

document.addEventListener('DOMContentLoaded', function() {
    const editForm = document.getElementById('editTripForm');
    if (editForm) {
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const tripId = document.getElementById('edit_trip_id').value;
            const updatedData = {
                country: document.getElementById('edit_country').value,
                entry_date: document.getElementById('edit_entry_date').value,
                exit_date: document.getElementById('edit_exit_date').value,
            };
            
            try {
                const response = await fetch(`/edit_trip/${tripId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData)
                });
                
                if (response.ok) {
                    location.reload();
                } else {
                    const data = await response.json();
                    alert('Error saving changes: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error saving changes');
            }
        });
    }
});
</script>

<style>
/* Dropdown Styles */
.dropdown-container { position: relative; }
.dropdown-input {
    width: 100%;
    padding: 12px 44px 12px 16px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    background: var(--base-bg);
    font-family: inherit;
    transition: all 0.2s;
}
.dropdown-input:focus {
    outline: none;
    border-color: #f97316;
    box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
}
.dropdown-list {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--base-bg);
    border: 1px solid #e5e7eb;
    border-top: none;
    border-radius: 0 0 8px 8px;
    max-height: 240px;
    overflow-y: auto;
    z-index: 100;
    display: none;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}
.dropdown-item {
    padding: 12px 16px;
    cursor: pointer;
    border-bottom: 1px solid #e5e7eb;
    color: #6b7280;
    transition: background-color 0.15s;
    display: flex;
    align-items: center;
    gap: 8px;
}
.dropdown-item:hover {
    background: #f9fafb;
    color: #f97316;
}
.dropdown-item:last-child { border-bottom: none; }
.dropdown-arrow {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: #6b7280;
    pointer-events: none;
    font-size: 12px;
}

/* Sortable Table Styles */
.sortable {
    cursor: pointer;
    user-select: none;
    position: relative;
    transition: all 0.2s ease;
}

.sortable:hover {
    background-color: #f9fafb;
    color: #f97316;
}

.sort-arrow {
    display: inline-block;
    margin-left: 6px;
    font-size: 12px;
    color: #9ca3af;
    transition: color 0.2s ease, transform 0.2s ease;
}

.sort-arrow.active {
    color: #f97316;
    font-weight: bold;
    transform: scale(1.2);
}

.sortable:hover .sort-arrow {
    color: #f97316;
}

/* Smooth row transitions */
#tripTableBody tr {
    transition: all 0.3s ease;
}

/* Tooltip styling for sortable headers */
.sortable[data-tooltip] {
    position: relative;
}

.sortable[data-tooltip]:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%) translateY(-8px);
    background: #1f2937;
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    white-space: nowrap;
    z-index: 1000;
    pointer-events: none;
    opacity: 0;
    animation: fadeInTooltip 0.2s ease forwards;
}

.sortable[data-tooltip]:hover::before {
    content: '';
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%) translateY(-2px);
    border: 5px solid transparent;
    border-top-color: #1f2937;
    z-index: 1000;
    opacity: 0;
    animation: fadeInTooltip 0.2s ease forwards;
}

@keyframes fadeInTooltip {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(-4px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(-8px);
    }
}

/* Add subtle highlight to sorted column */
.sortable.active-sort {
    background-color: #fef3c7;
}
</style>
{% endblock %}