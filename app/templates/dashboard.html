{% extends "base.html" %}

{% block title %}Dashboard - EU Trip Tracker{% endblock %}

{% block content %}
<div class="content-header">
    <h1 class="content-title">EU Trip Tracker Dashboard</h1>
    <p class="content-subtitle">Monitor employee travel compliance with the 90/180 day rule</p>
</div>

<div class="content-body">
    <!-- At Risk Alert Section -->
    {% if at_risk_employees %}
    <div class="card" style="border: 2px solid #dc2626; background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); margin-bottom: 24px;">
        <div class="card-header" style="background: #dc2626; color: white;">
            <h2 class="card-title" style="color: white; display: flex; align-items: center; gap: 8px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                {{ at_risk_employees|length }} Employee{{ 's' if at_risk_employees|length != 1 else '' }} at Risk
                <button class="help-icon" 
                        data-help="These employees have used 76+ days in the EU within the last 180 days and have 2 weeks or less remaining in their 90-day allowance. Immediate action is required to prevent compliance violations."
                        data-help-title="At Risk Employees"
                        style="background: rgba(255,255,255,0.2); color: white; margin-left: auto;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                </button>
            </h2>
            <p style="color: #fecaca; margin: 0; font-size: 14px;">
                These employees have used 76+ days in the EU and have 2 weeks or less remaining
            </p>
        </div>
        <div class="card-body" style="padding: 20px;">
            <div style="display: grid; gap: 16px;">
                {% for emp in at_risk_employees %}
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background: var(--base-bg); border-radius: 8px; border-left: 4px solid #dc2626; box-shadow: 0 2px 4px rgba(220, 38, 38, 0.1);">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <div style="width: 8px; height: 8px; background: #dc2626; border-radius: 50%;"></div>
                            <h3 style="margin: 0; color: #1f2937; font-size: 16px; font-weight: 600;">{{ emp.name }}</h3>
                            <span class="badge badge-danger">
                                {{ emp.days_used }}/90 days
                            </span>
                        </div>
                        <div style="display: flex; gap: 24px; font-size: 14px; color: #6b7280;">
                            <div>
                                <strong>Days Remaining:</strong> 
                                <span style="color: #dc2626; font-weight: 600;">{{ emp.days_remaining }}</span>
                            </div>
                            <div>
                                <strong>Next Trip:</strong> 
                                {% if emp.next_trip %}
                                    <span style="color: #1f2937;">
                                        {{ emp.next_trip['country'] }} - {{ emp.next_trip['entry_date']|format_date }}
                                        {% if emp.next_trip['country']|is_ireland %}
                                            <span style="color: #9ca3af; font-size: 11px;">(Non-Schengen)</span>
                                        {% endif %}
                                    </span>
                                {% else %}
                                    <span style="color: #6b7280;">No upcoming trips</span>
                                {% endif %}
                            </div>
                        </div>
                        {% if emp.days_until_compliant is not none and emp.days_until_compliant > 0 %}
                        <div style="margin-top: 8px; font-size: 12px; color: #9ca3af;">
                            <strong>Days Until Compliant:</strong> 
                            <span style="color: #dc2626; font-weight: 600;">{{ emp.days_until_compliant }}</span>
                            {% if emp.compliance_date %}
                                <span style="color: #9ca3af;">({{ emp.compliance_date }})</span>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <a href="{{ url_for('main.employee_detail', employee_id=emp.id) }}" 
                           class="btn" 
                           style="background: #dc2626; color: white; padding: 8px 16px; border-radius: 4px; text-decoration: none; font-size: 14px; font-weight: 500;">
                            View Details
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div style="margin-top: 16px; padding: 12px; background: #fef2f2; border-radius: 6px; border: 1px solid #fecaca;">
                <p style="margin: 0; color: #991b1b; font-size: 14px;">
                    <strong>Action Required:</strong> These employees have 2 weeks or less remaining in their 90-day EU allowance. 
                    Immediate planning required for any upcoming EU travel. Click "View Details" for full travel history.
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Future Compliance Alerts Summary -->
    {% if future_alerts_red or future_alerts_yellow or future_alerts_green %}
    <div class="card" style="border-left: 4px solid #3182ce; margin-bottom: 24px;">
        <div class="card-header" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);">
            <h2 class="card-title" style="color: #1e40af; display: flex; align-items: center; gap: 8px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                Future Job Compliance Forecast
            </h2>
            <p style="color: #1e40af; margin: 0; font-size: 14px;">
                {{ future_alerts_red + future_alerts_yellow + future_alerts_green }} scheduled future job{{ 's' if (future_alerts_red + future_alerts_yellow + future_alerts_green) != 1 else '' }} analyzed
            </p>
        </div>
        <div class="card-body" style="padding: 20px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
                <div style="padding: 16px; background: #fee; border-left: 4px solid #c53030; border-radius: 8px;">
                    <div style="font-size: 32px; font-weight: 700; color: #c53030; margin-bottom: 4px;">{{ future_alerts_red }}</div>
                    <div style="color: #742a2a; font-size: 14px;">Critical (90+ days)</div>
                </div>
                <div style="padding: 16px; background: #fefce8; border-left: 4px solid #ca8a04; border-radius: 8px;">
                    <div style="font-size: 32px; font-weight: 700; color: #ca8a04; margin-bottom: 4px;">{{ future_alerts_yellow }}</div>
                    <div style="color: #713f12; font-size: 14px;">Warning (approaching limit)</div>
                </div>
                <div style="padding: 16px; background: #f0fdf4; border-left: 4px solid #16a34a; border-radius: 8px;">
                    <div style="font-size: 32px; font-weight: 700; color: #16a34a; margin-bottom: 4px;">{{ future_alerts_green }}</div>
                    <div style="color: #14532d; font-size: 14px;">Safe (compliant)</div>
                </div>
            </div>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <a href="{{ url_for('main.future_job_alerts') }}" class="btn btn-primary" style="background: #3182ce; color: white; padding: 10px 20px; text-decoration: none; border-radius: 6px; font-weight: 500;">
                    View All Future Alerts
                </a>
                <a href="{{ url_for('main.what_if_scenario') }}" class="btn btn-outline" style="border: 2px solid #3182ce; color: #3182ce; padding: 10px 20px; text-decoration: none; border-radius: 6px; font-weight: 500; background: white;">
                    Open Compliance Planner
                </a>
            </div>
            {% if future_alerts_red > 0 %}
            <div style="margin-top: 16px; padding: 12px; background: #fee; border-radius: 6px; border: 1px solid #fecaca;">
                <p style="margin: 0; color: #991b1b; font-size: 14px;">
                    <strong>Action Required:</strong> {{ future_alerts_red }} future job{{ 's' if future_alerts_red != 1 else '' }} would exceed the 90-day EU limit. 
                    Review and reschedule to ensure compliance.
                </p>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Add Employee Section -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Add New Employee</h2>
            <div style="display: flex; gap: 12px;">
                <a href="{{ url_for('main.bulk_add_trip') }}" class="btn btn-primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="8.5" cy="7" r="4"></circle>
                        <line x1="20" y1="8" x2="20" y2="14"></line>
                        <line x1="23" y1="11" x2="17" y2="11"></line>
                    </svg>
                    Bulk Add Trip
                </a>
                <a href="{{ url_for('main.import_excel') }}" class="btn btn-success">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14,2 14,8 20,8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                    </svg>
                    Import Excel
                </a>
            </div>
        </div>
        <form method="POST" action="{{ url_for('main.add_employee') }}" class="form-inline" data-employee-form="true">
            <div class="form-group">
                <label class="form-label required">Employee Name</label>
                <input type="text" name="name" class="form-input" placeholder="Enter employee name" required minlength="2" maxlength="100">
            </div>
            <button type="submit" class="btn btn-primary">Add Employee</button>
        </form>
    </div>

    {% if employees %}
    <!-- Employee Overview Section -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Employee Overview</h2>
            <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                <!-- Search and Filter Controls -->
                <div style="display: flex; gap: 8px; align-items: center; flex: 1; min-width: 300px;">
                    <div style="position: relative; flex: 1;">
                        <input type="text" id="employeeSearch" placeholder="Search employees..." 
                               style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; background: var(--base-bg);">
                        <svg style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #6b7280; width: 16px; height: 16px;" 
                             viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="M21 21l-4.35-4.35"></path>
                        </svg>
                    </div>
                    <button id="filterBtn" class="btn btn-outline btn-sm" onclick="toggleFilterPanel()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="22,3 2,3 10,12.46 10,19 14,21 14,12.46"></polygon>
                        </svg>
                        Filters
                    </button>
                </div>
                
                <!-- Sort and View Controls -->
                <div style="display: flex; gap: 8px; align-items: center;">
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <label style="font-size: 14px; color: #6b7280; font-weight: 500;">Sort by:</label>
                        <select id="sortSelect" onchange="changeSort()" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; background: var(--base-bg);">
                            <option value="first_name" {% if current_sort == 'first_name' %}selected{% endif %}>First Name</option>
                            <option value="last_name" {% if current_sort == 'last_name' %}selected{% endif %}>Last Name</option>
                            <option value="days_used" {% if current_sort == 'days_used' %}selected{% endif %}>Days Used</option>
                            <option value="days_remaining" {% if current_sort == 'days_remaining' %}selected{% endif %}>Days Remaining</option>
                            <option value="trip_count" {% if current_sort == 'trip_count' %}selected{% endif %}>Trip Count</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="showTableView()" id="tableBtn" class="btn btn-primary btn-sm">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="7" height="7"></rect>
                                <rect x="14" y="3" width="7" height="7"></rect>
                                <rect x="14" y="14" width="7" height="7"></rect>
                                <rect x="3" y="14" width="7" height="7"></rect>
                            </svg>
                            Table View
                        </button>
                        <button onclick="showCardView()" id="cardsBtn" class="btn btn-outline btn-sm">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <rect x="7" y="7" width="3" height="3"></rect>
                                <rect x="14" y="7" width="3" height="3"></rect>
                                <rect x="14" y="14" width="3" height="3"></rect>
                                <rect x="7" y="14" width="3" height="3"></rect>
                            </svg>
                            Card View
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Advanced Filter Panel -->
            <div id="filterPanel" class="filter-panel" style="display: none; margin-top: 16px; padding: 16px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Risk Level</label>
                        <select id="riskFilter" class="form-select">
                            <option value="">All Risk Levels</option>
                            <option value="red">At Risk (0-14 days)</option>
                            <option value="amber">Caution (15-30 days)</option>
                            <option value="green">Safe (31+ days)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Days Used Range</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="number" id="minDays" placeholder="Min" min="0" max="90" class="form-input" style="width: 80px;">
                            <span style="align-self: center; color: #6b7280;">to</span>
                            <input type="number" id="maxDays" placeholder="Max" min="0" max="90" class="form-input" style="width: 80px;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Has Upcoming Trips</label>
                        <select id="upcomingTripsFilter" class="form-select">
                            <option value="">All Employees</option>
                            <option value="yes">Has Upcoming Trips</option>
                            <option value="no">No Upcoming Trips</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Trip Count Range</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="number" id="minTrips" placeholder="Min" min="0" class="form-input" style="width: 80px;">
                            <span style="align-self: center; color: #6b7280;">to</span>
                            <input type="number" id="maxTrips" placeholder="Max" min="0" class="form-input" style="width: 80px;">
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 8px; margin-top: 16px; justify-content: flex-end;">
                    <button onclick="clearFilters()" class="btn btn-outline btn-sm">Clear Filters</button>
                    <button onclick="applyFilters()" class="btn btn-primary btn-sm">Apply Filters</button>
                </div>
            </div>
        </div>

        <!-- Table View -->
        <div id="tableView" class="table-container">
            <table id="employeeTable" class="table">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)" style="cursor: pointer;" data-tooltip="Click to sort by employee name">
                            Name 
                            <span class="sort-arrow">â†•</span>
                        </th>
                        <th onclick="sortTable(1)" style="cursor: pointer;" data-tooltip="Click to sort by number of trips">
                            Trips 
                            <span class="sort-arrow">â†•</span>
                        </th>
                        <th onclick="sortTable(2)" style="cursor: pointer;" data-tooltip="Click to sort by days used in the last 180 days">
                            Days Used 
                            <span class="sort-arrow">â†•</span>
                        </th>
                        <th onclick="sortTable(3)" style="cursor: pointer;" data-tooltip="Click to sort by days remaining in 90-day allowance">
                            Days Remaining
                            <span class="sort-arrow">â†•</span>
                        </th>
                        <th onclick="sortTable(4)" style="cursor: pointer;" data-tooltip="Click to sort by next scheduled trip">
                            Next Trip 
                            <span class="sort-arrow">â†•</span>
                        </th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for emp in employees %}
                    <tr>
                        <td style="font-weight: 600;">
                            <a href="{{ url_for('main.employee_detail', employee_id=emp.id) }}" style="color: #3b82f6; text-decoration: none; cursor: pointer;">
                                {{ emp.name }}
                            </a>
                            {% if emp.earliest_safe_entry %}
                                <br><small class="text-muted" style="font-size: 11px;" title="Earliest safe re-entry date">
                                    Safe entry: {{ emp.earliest_safe_entry }}
                                </small>
                            {% endif %}
                        </td>
                        <td class="text-center">{{ emp.trip_count }}</td>
                        <td class="text-center">
                            <span style="font-weight: 700; color: {% if emp.days_used > 80 %}#ef4444{% elif emp.days_used > 60 %}#f59e0b{% else %}#10b981{% endif %};">
                                {{ emp.days_used }}/90
                            </span>
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="flex: 1; min-width: 100px;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                        <span style="font-weight: 600; font-size: 14px; {% if emp.risk_level == 'red' %}color: #ef4444;{% elif emp.risk_level == 'amber' %}color: #f59e0b;{% else %}color: #10b981;{% endif %}">
                                            {{ emp.days_remaining }} days
                                        </span>
                                    </div>
                                    <div style="background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden;">
                                        <div style="height: 100%; width: {{ (emp.days_remaining / 90 * 100)|round|int }}%; background: {% if emp.risk_level == 'red' %}#ef4444{% elif emp.risk_level == 'amber' %}#f59e0b{% else %}#10b981{% endif %}; transition: all 0.3s;" 
                                             title="{{ emp.days_used }} of 90 days used"></div>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if emp.next_trip %}
                                <span class="status-badge status-safe" style="font-size: 12px;">
                                    {{ emp.next_trip.country }} - {{ emp.next_trip.entry_date|format_date }}
                                </span>
                            {% else %}
                                <span class="text-muted" style="font-style: italic;">No upcoming trips</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <div style="display: flex; gap: 8px; justify-content: center;">
                                <a href="{{ url_for('main.employee_detail', employee_id=emp.id) }}" class="btn btn-primary btn-sm">Details</a>
                                <a href="{{ url_for('main.calendar', employee_id=emp.id) }}" class="btn btn-secondary btn-sm">ðŸ“…</a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Card View -->
        <div id="cardView" class="grid grid-2" style="display: none;">
            {% for emp in employees %}
            <div class="card" data-employee-name="{{ emp.name }}">
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 18px; font-weight: 600;">{{ emp.name }}</h3>
                    <span class="status-badge {% if emp.risk_level == 'red' %}status-danger{% elif emp.risk_level == 'amber' %}status-warning{% else %}status-safe{% endif %}">
                        {{ emp.days_remaining }} days left
                    </span>
                </div>
                
                <div class="compliance-summary" style="background: #f9fafb; padding: 16px; border-radius: 8px; border-left: 4px solid {% if emp.risk_level == 'red' %}var(--status-danger){% elif emp.risk_level == 'amber' %}var(--status-warning){% else %}var(--status-safe){% endif %}; margin-bottom: 16px;">
                    <div class="compliance-header">
                        <span class="compliance-label">Days used (last 6 months):</span>
                        <span class="compliance-value">{{ emp.days_used }}/90</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ (emp.days_remaining / 90 * 100)|round|int }}%; background: {% if emp.risk_level == 'red' %}var(--status-danger){% elif emp.risk_level == 'amber' %}var(--status-warning){% else %}var(--status-safe){% endif %};"></div>
                    </div>
                    <div class="compliance-details" style="margin-top: 12px;">
                        <div class="detail-item">
                            <span class="detail-label">Days remaining:</span>
                            <span class="detail-value {% if emp.risk_level == 'red' %}text-danger{% elif emp.risk_level == 'amber' %}text-warning{% else %}text-success{% endif %}">{{ emp.days_remaining }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Status:</span>
                            <span class="badge {% if emp.risk_level == 'red' %}badge-danger{% elif emp.risk_level == 'amber' %}badge-warning{% else %}badge-success{% endif %}">
                                {% if emp.risk_level == 'red' %}At Risk{% elif emp.risk_level == 'amber' %}Caution{% else %}Safe{% endif %}
                            </span>
                        </div>
                    </div>
                </div>
                
                {% if emp.earliest_safe_entry %}
                <div style="margin-bottom: 16px; padding: 12px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <div style="font-size: 14px; color: #92400e; font-weight: 500;">Earliest Safe Entry</div>
                    <div style="font-size: 13px; color: #92400e;">{{ emp.earliest_safe_entry }}</div>
                </div>
                {% endif %}
                
                {% if emp.next_trip %}
                <div style="margin-bottom: 16px; padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <div style="font-size: 14px; color: #1e40af; font-weight: 500;">Next Trip</div>
                    <div style="font-size: 13px; color: #1e40af;">{{ emp.next_trip.country }} - {{ emp.next_trip.entry_date|format_date }}</div>
                </div>
                {% endif %}
                
                <div style="display: flex; gap: 8px;">
                    <a href="{{ url_for('main.employee_detail', employee_id=emp.id) }}" class="btn btn-primary btn-sm" style="flex: 1;">Details</a>
                    <a href="{{ url_for('main.calendar', employee_id=emp.id) }}" class="btn btn-secondary btn-sm" style="flex: 1;">ðŸ“… Calendar</a>
                    {# Delete action disabled: route not implemented
                    <form method="POST" action="{{ url_for('main.delete_employee', employee_id=emp.id) }}" style="flex: 1;" onsubmit="return confirm('Are you sure you want to delete this employee?');">
                        <button type="submit" class="btn btn-danger btn-sm" style="width: 100%;">Delete</button>
                    </form>
                    #}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="card text-center" style="padding: 60px 24px;">
        <h3 style="color: #1f2937; font-weight: 600; margin-bottom: 8px; font-size: 20px;">No Employees Yet</h3>
        <p class="text-muted">Add your first employee using the form above</p>
    </div>
    {% endif %}

    <!-- Recent Actions Section -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Recent Actions</h2>
        </div>
        <div class="card-body">
            <div id="recentActions" class="recent-actions">
                <div class="recent-action-item">
                    <div class="recent-action-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="8.5" cy="7" r="4"></circle>
                            <line x1="20" y1="8" x2="20" y2="14"></line>
                            <line x1="23" y1="11" x2="17" y2="11"></line>
                        </svg>
                    </div>
                    <div class="recent-action-content">
                        <div class="recent-action-title">Employee added</div>
                        <div class="recent-action-details">John Doe was added to the system</div>
                        <div class="recent-action-time">2 minutes ago</div>
                    </div>
                </div>
                <div class="recent-action-item">
                    <div class="recent-action-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <polyline points="9,22 9,12 15,12 15,22"></polyline>
                        </svg>
                    </div>
                    <div class="recent-action-content">
                        <div class="recent-action-title">Trip added</div>
                        <div class="recent-action-details">Jane Smith - France (Paris)</div>
                        <div class="recent-action-time">15 minutes ago</div>
                    </div>
                </div>
                <div class="recent-action-item">
                    <div class="recent-action-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14,2 14,8 20,8"></polyline>
                        </svg>
                    </div>
                    <div class="recent-action-content">
                        <div class="recent-action-title">Data imported</div>
                        <div class="recent-action-details">15 trips imported from Excel</div>
                        <div class="recent-action-time">1 hour ago</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
/* Mobile-specific fixes */
@media (max-width: 768px) {
    /* Force card view on mobile for better UX */
    #tableView {
        display: none !important;
    }
    
    #cardView {
        display: grid !important;
    }
    
    /* Hide view toggle buttons */
    #tableBtn, #cardsBtn {
        display: none !important;
    }
    
    /* Single column layout for cards */
    #cardView.grid-2 {
        grid-template-columns: 1fr;
    }
    
    /* Make card header buttons wrap */
    .card-header > div {
        flex-wrap: wrap;
    }
    
    .card-header h2 {
        width: 100%;
    }
}
</style>

<script>
// Initialize view - card view on mobile, table view on desktop
document.addEventListener('DOMContentLoaded', function() {
    const isMobile = window.innerWidth < 768;
    
    if (isMobile) {
        showCardView();
    } else {
        showTableView();
    }
    
    // Handle window resize
    window.addEventListener('resize', function() {
        const isMobile = window.innerWidth < 768;
        if (isMobile) {
            showCardView();
        }
    });
});

function showTableView() {
    const tableView = document.getElementById('tableView');
    const cardView = document.getElementById('cardView');
    const tableBtn = document.getElementById('tableBtn');
    const cardsBtn = document.getElementById('cardsBtn');
    
    if (tableView) tableView.style.display = 'block';
    if (cardView) cardView.style.display = 'none';
    if (tableBtn && cardsBtn) {
        tableBtn.className = 'btn btn-primary btn-sm';
        cardsBtn.className = 'btn btn-outline btn-sm';
    }
}

function showCardView() {
    const tableView = document.getElementById('tableView');
    const cardView = document.getElementById('cardView');
    const tableBtn = document.getElementById('tableBtn');
    const cardsBtn = document.getElementById('cardsBtn');
    
    if (tableView) tableView.style.display = 'none';
    if (cardView) cardView.style.display = 'grid';
    if (tableBtn && cardsBtn) {
        tableBtn.className = 'btn btn-outline btn-sm';
        cardsBtn.className = 'btn btn-primary btn-sm';
    }
}

// Advanced filtering and search functionality
let allEmployees = [];
let filteredEmployees = [];

// Initialize search and filtering
document.addEventListener('DOMContentLoaded', function() {
    // Store all employees data for filtering
    allEmployees = Array.from(document.querySelectorAll('#employeeTable tbody tr')).map(row => {
        const cells = row.cells;
        const nameCell = cells[0];
        const nameLink = nameCell.querySelector('a');
        const name = nameLink ? nameLink.textContent.trim() : nameCell.textContent.trim();
        
        return {
            element: row,
            name: name,
            tripCount: parseInt(cells[1].textContent.trim()) || 0,
            daysUsed: parseInt(cells[2].textContent.trim().split('/')[0]) || 0,
            daysRemaining: parseInt(cells[3].textContent.trim().split(' ')[0]) || 0,
            nextTrip: cells[4].textContent.trim(),
            riskLevel: getRiskLevel(parseInt(cells[3].textContent.trim().split(' ')[0]) || 0)
        };
    });
    
    filteredEmployees = [...allEmployees];
    
    // Initialize search
    const searchInput = document.getElementById('employeeSearch');
    if (searchInput) {
        searchInput.addEventListener('input', debounce(performSearch, 300));
    }
    
    // Initialize filters
    initializeFilters();
});

function getRiskLevel(daysRemaining) {
    if (daysRemaining <= 14) return 'red';
    if (daysRemaining <= 30) return 'amber';
    return 'green';
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function performSearch() {
    const searchTerm = document.getElementById('employeeSearch').value.toLowerCase().trim();
    
    if (!searchTerm) {
        filteredEmployees = [...allEmployees];
    } else {
        filteredEmployees = allEmployees.filter(emp => 
            emp.name.toLowerCase().includes(searchTerm)
        );
    }
    
    applyFilters();
}

function toggleFilterPanel() {
    const panel = document.getElementById('filterPanel');
    const btn = document.getElementById('filterBtn');
    
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        btn.classList.add('btn-primary');
        btn.classList.remove('btn-outline');
    } else {
        panel.style.display = 'none';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline');
    }
}

function initializeFilters() {
    // Add event listeners to all filter inputs
    const filterInputs = [
        'riskFilter', 'minDays', 'maxDays', 'upcomingTripsFilter', 'minTrips', 'maxTrips'
    ];
    
    filterInputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', applyFilters);
            element.addEventListener('input', debounce(applyFilters, 300));
        }
    });
}

function applyFilters() {
    const riskFilter = document.getElementById('riskFilter').value;
    const minDays = parseInt(document.getElementById('minDays').value) || 0;
    const maxDays = parseInt(document.getElementById('maxDays').value) || 90;
    const upcomingTrips = document.getElementById('upcomingTripsFilter').value;
    const minTrips = parseInt(document.getElementById('minTrips').value) || 0;
    const maxTrips = parseInt(document.getElementById('maxTrips').value) || 999;
    
    // Start with search results
    let results = [...filteredEmployees];
    
    // Apply risk level filter
    if (riskFilter) {
        results = results.filter(emp => emp.riskLevel === riskFilter);
    }
    
    // Apply days used range filter
    results = results.filter(emp => emp.daysUsed >= minDays && emp.daysUsed <= maxDays);
    
    // Apply upcoming trips filter
    if (upcomingTrips === 'yes') {
        results = results.filter(emp => emp.nextTrip !== 'No upcoming trips');
    } else if (upcomingTrips === 'no') {
        results = results.filter(emp => emp.nextTrip === 'No upcoming trips');
    }
    
    // Apply trip count range filter
    results = results.filter(emp => emp.tripCount >= minTrips && emp.tripCount <= maxTrips);
    
    // Update display
    updateEmployeeDisplay(results);
    
    // Update results count
    updateResultsCount(results.length, allEmployees.length);
}

function updateEmployeeDisplay(employees) {
    const tbody = document.querySelector('#employeeTable tbody');
    const cardView = document.getElementById('cardView');
    
    if (!tbody) return;
    
    // Hide all rows first
    allEmployees.forEach(emp => {
        emp.element.style.display = 'none';
    });
    
    // Show filtered rows
    employees.forEach(emp => {
        emp.element.style.display = '';
    });
    
    // Update card view if visible
    if (cardView && cardView.style.display !== 'none') {
        updateCardView(employees);
    }
}

function updateCardView(employees) {
    const cardView = document.getElementById('cardView');
    if (!cardView) return;
    
    // Hide all cards
    const cards = cardView.querySelectorAll('.card');
    cards.forEach(card => card.style.display = 'none');
    
    // Show filtered cards
    employees.forEach(emp => {
        const card = cardView.querySelector(`[data-employee-name="${emp.name}"]`);
        if (card) {
            card.style.display = 'block';
        }
    });
}

function updateResultsCount(filtered, total) {
    // Add or update results count display
    let countDisplay = document.getElementById('resultsCount');
    if (!countDisplay) {
        countDisplay = document.createElement('div');
        countDisplay.id = 'resultsCount';
        countDisplay.style.cssText = 'margin-top: 12px; padding: 8px 12px; background: #f0f9ff; border-radius: 6px; font-size: 14px; color: #1e40af;';
        document.querySelector('.card-header').appendChild(countDisplay);
    }
    
    if (filtered === total) {
        countDisplay.textContent = `Showing all ${total} employees`;
    } else {
        countDisplay.textContent = `Showing ${filtered} of ${total} employees`;
    }
}

function clearFilters() {
    // Reset all filter inputs
    document.getElementById('riskFilter').value = '';
    document.getElementById('minDays').value = '';
    document.getElementById('maxDays').value = '';
    document.getElementById('upcomingTripsFilter').value = '';
    document.getElementById('minTrips').value = '';
    document.getElementById('maxTrips').value = '';
    document.getElementById('employeeSearch').value = '';
    
    // Reset to show all employees
    filteredEmployees = [...allEmployees];
    updateEmployeeDisplay(allEmployees);
    updateResultsCount(allEmployees.length, allEmployees.length);
}

function changeSort() {
    const sortSelect = document.getElementById('sortSelect');
    const sortValue = sortSelect.value;
    
    // Redirect to dashboard with new sort parameter
    const url = new URL(window.location);
    url.searchParams.set('sort', sortValue);
    window.location.href = url.toString();
}
</script>
{% endblock %}