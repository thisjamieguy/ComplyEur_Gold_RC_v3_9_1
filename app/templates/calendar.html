<!-- DayPilot references fully removed – system prepared for native calendar rebuild (Phase 3.5). -->
{% extends "base.html" %}
{% block title %}Calendar - EU Trip Tracker{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{{ url_for('main.home') }}">Home</a></li>
<li class="breadcrumb-item active" aria-current="page">Calendar</li>
{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/calendar.css') }}?v=1.7.7">
{% endblock %}

{% block content %}
<div class="calendar-page">
    <div class="calendar-banner" role="status" aria-live="polite">
        <strong>Heads up:</strong> Native calendar rebuild rolling out in Phase 3.5. All trip data and endpoints remain fully operational.
    </div>
    <div id="calendar"
         class="calendar-shell"
         data-warning-threshold="{{ config['CONFIG'].get('FUTURE_JOB_WARNING_THRESHOLD', 80) }}"
         data-focus-employee="{{ employee_id if employee_id is defined else '' }}"
         data-focus-employee-name="{{ employee_name if employee_name is defined else '' }}">
        <header class="calendar-toolbar">
            <div class="calendar-toolbar-left">
                <button type="button" class="calendar-btn" data-action="prev" aria-label="Show previous month range">
                    <span aria-hidden="true">←</span>
                </button>
                <button type="button" class="calendar-btn calendar-btn--primary" data-action="today">
                    Today
                </button>
                <button type="button" class="calendar-btn" data-action="next" aria-label="Show next month range">
                    <span aria-hidden="true">→</span>
                </button>
                <h1 class="calendar-title">
                    <span id="calendar-range-label">Loading range…</span>
                    {% if employee_name is defined %}
                    <small class="calendar-focus-label">Focused on {{ employee_name }}</small>
                    {% endif %}
                </h1>
            </div>
            <div class="calendar-toolbar-right">
                <div class="calendar-toolbar-actions">
                    <label for="calendar-future-weeks" class="calendar-toolbar-label">Future view:</label>
                    <select id="calendar-future-weeks" class="calendar-select">
                        <option value="4">4 weeks</option>
                        <option value="5">5 weeks</option>
                        <option value="6" selected>6 weeks</option>
                        <option value="7">7 weeks</option>
                        <option value="8">8 weeks</option>
                        <option value="9">9 weeks</option>
                        <option value="10">10 weeks</option>
                    </select>
                    <div class="calendar-toolbar-buttons" role="group" aria-label="Trip actions">
                        <button type="button" class="calendar-btn calendar-btn--accent" data-action="add-trip">
                            Add Trip
                        </button>
                        <button type="button" class="calendar-btn calendar-btn--secondary" data-action="edit-trip-global" disabled aria-disabled="true">
                            Edit Trip
                        </button>
                    </div>
                </div>
                <div class="calendar-search">
                    <label for="calendar-search-input" class="visually-hidden">Filter employees</label>
                    <input id="calendar-search-input" type="search" placeholder="Filter employees…" autocomplete="off">
                    <button type="button" class="calendar-search-clear" aria-label="Clear search">×</button>
                </div>
            </div>
        </header>

        <section class="calendar-legend" aria-label="Calendar legend">
            <div class="calendar-legend-item">
                <span class="calendar-legend-swatch calendar-legend-swatch--safe"></span>
                <span>Compliant &lt; 60 days</span>
            </div>
            <div class="calendar-legend-item">
                <span class="calendar-legend-swatch calendar-legend-swatch--warning"></span>
                <span>Approaching limit 60–89 days</span>
            </div>
            <div class="calendar-legend-item">
                <span class="calendar-legend-swatch calendar-legend-swatch--critical"></span>
                <span>Exceeded ≥ 90 days</span>
            </div>
        </section>

        <section class="calendar-main" aria-live="polite">
            <div class="calendar-header-row">
                <div class="calendar-employee-header">
                    <span>Employees</span>
                </div>
                <div class="calendar-timeline-header">
                    <div class="calendar-month-row" id="calendar-month-row"></div>
                    <div class="calendar-day-row" id="calendar-day-row"></div>
                    <div class="calendar-today-marker" id="calendar-today-marker" aria-hidden="true"></div>
                </div>
            </div>
            <div class="calendar-body">
                <div class="calendar-employee-list" id="calendar-employee-list" role="listbox" aria-label="Employees"></div>
                <div class="calendar-timeline">
                    <div class="calendar-timeline-inner" id="calendar-timeline">
                        <!-- Phase 3.6.1: Drag-and-drop handles mount inside the grid rows here. -->
                        <div class="calendar-grid" id="calendar-grid"></div>
                        <div class="calendar-today-marker calendar-today-marker--body" id="calendar-today-marker-body" aria-hidden="true"></div>
                    </div>
                </div>
            </div>
        </section>

        <div class="calendar-detail-overlay" id="calendar-detail-overlay" role="dialog" aria-modal="true" hidden>
            <div class="calendar-detail" role="document" aria-labelledby="calendar-detail-title" tabindex="-1">
                <header class="calendar-detail-header">
                    <div class="calendar-detail-heading">
                        <div class="calendar-detail-status-row">
                            <span class="trip-color-badge trip-color" id="calendar-detail-status-dot" aria-hidden="true"></span>
                            <p class="calendar-detail-label" id="calendar-detail-status">Compliant trip</p>
                        </div>
                        <h2 class="calendar-detail-title" id="calendar-detail-title">Trip details</h2>
                        <p class="calendar-detail-subtitle" id="calendar-detail-employee"></p>
                    </div>
                    <div class="calendar-detail-actions">
                        <button type="button" class="calendar-btn calendar-btn--outline" data-action="edit-trip">
                            Edit Trip
                        </button>
                    </div>
                    <button type="button" class="calendar-detail-close" data-action="close-detail" aria-label="Close trip details">
                        ×
                    </button>
                </header>
                <section class="calendar-detail-body" id="calendar-detail-body">
                    <div class="calendar-detail-meta">
                        <div>
                            <span class="calendar-detail-meta-label">Country</span>
                            <span class="calendar-detail-meta-value" id="calendar-detail-country">—</span>
                        </div>
                        <div>
                            <span class="calendar-detail-meta-label">Travel window</span>
                            <span class="calendar-detail-meta-value" id="calendar-detail-dates">—</span>
                        </div>
                        <div>
                            <span class="calendar-detail-meta-label">Duration</span>
                            <span class="calendar-detail-meta-value" id="calendar-detail-duration">—</span>
                        </div>
                        <div>
                            <span class="calendar-detail-meta-label">Rolling 180-day usage</span>
                            <span class="calendar-detail-meta-value" id="calendar-detail-usage">—</span>
                        </div>
                    </div>
                    <div class="calendar-detail-notes" id="calendar-detail-notes" hidden>
                        <h3>Notes</h3>
                        <p id="calendar-detail-purpose"></p>
                    </div>
                    <dl class="calendar-detail-list">
                        <div class="calendar-detail-list-item" id="calendar-detail-jobref" hidden>
                            <dt>Job reference</dt>
                            <dd id="calendar-detail-jobref-value">—</dd>
                        </div>
                        <div class="calendar-detail-list-item" id="calendar-detail-updated" hidden>
                            <dt>Last updated</dt>
                            <dd id="calendar-detail-updated-value">—</dd>
                        </div>
                        <div class="calendar-detail-list-item" id="calendar-detail-created" hidden>
                            <dt>Created</dt>
                            <dd id="calendar-detail-created-value">—</dd>
                        </div>
                    </dl>
                </section>
            </div>
        </div>

        <div class="calendar-form-overlay" id="calendar-form-overlay" role="dialog" aria-modal="true" hidden>
            <div class="calendar-form" role="document" aria-labelledby="calendar-form-title" tabindex="-1">
                <header class="calendar-form-header">
                    <div class="calendar-form-titles">
                        <h2 class="calendar-form-title" id="calendar-form-title">Add trip</h2>
                        <p class="calendar-form-subtitle" id="calendar-form-subtitle">Create a new travel record</p>
                    </div>
                    <button type="button" class="calendar-form-close" data-action="close-form" aria-label="Close form">
                        ×
                    </button>
                </header>
                <form id="calendar-form" class="calendar-form-body" novalidate>
                    <div class="calendar-form-grid">
                        <label class="calendar-form-field">
                            <span>Employee</span>
                            <select id="calendar-form-employee" name="employee_id" required></select>
                        </label>
                        <label class="calendar-form-field">
                            <span>Country</span>
                            <input id="calendar-form-country" name="country" type="text" maxlength="80" required>
                        </label>
                        <label class="calendar-form-field">
                            <span>Entry date</span>
                            <input id="calendar-form-start" name="start_date" type="date" required>
                        </label>
                        <label class="calendar-form-field">
                            <span>Exit date</span>
                            <input id="calendar-form-end" name="end_date" type="date" required>
                        </label>
                        <label class="calendar-form-field">
                            <span>Job reference <small>(optional)</small></span>
                            <input id="calendar-form-jobref" name="job_ref" type="text" maxlength="120" autocomplete="off">
                        </label>
                        <label class="calendar-form-field calendar-form-field--wide">
                            <span>Purpose / notes <small>(optional)</small></span>
                            <textarea id="calendar-form-purpose" name="purpose" rows="3" maxlength="500"></textarea>
                        </label>
                    </div>
                    <div class="calendar-form-footer">
                        <div class="calendar-form-feedback" id="calendar-form-feedback" aria-live="polite" hidden></div>
                        <div class="calendar-form-actions">
                            <button type="button" class="calendar-btn calendar-btn--ghost" data-action="close-form">
                                Cancel
                            </button>
                            <button type="submit" class="calendar-btn calendar-btn--primary" data-action="submit-form">
                                Save Trip
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="calendar-loading" id="calendar-loading" hidden>
            <svg viewBox="0 0 50 50" class="calendar-spinner" aria-hidden="true">
                <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="4"/>
            </svg>
            <p>Loading trips…</p>
        </div>

        <div class="calendar-empty-state" id="calendar-empty" hidden>
            <svg viewBox="0 0 24 24" aria-hidden="true">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            <p>No trips found for selected range.</p>
        </div>

        <div class="calendar-error" id="calendar-error" hidden>
            <strong>We couldn’t load the calendar.</strong>
            <p>Check your connection and try again.</p>
            <button type="button" class="calendar-btn calendar-btn--retry" data-action="retry">Retry</button>
        </div>

        <div class="calendar-toast" id="calendar-toast" role="status" aria-live="polite" aria-hidden="true"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    <script>
    (function(){
      try{
        if(localStorage.getItem('calendarSplashDismissed_v177')==='true') return;
      }catch(e){}

      const overlay=document.createElement('div');
      overlay.className='modal-overlay active';
      overlay.innerHTML = `
        <div class="modal-container" style="max-width:560px">
          <div class="modal-header">
            <h3 class="modal-title">Welcome</h3>
          </div>
          <div class="modal-body">
            <div style="display:flex;flex-direction:column;align-items:center;gap:16px">
              <img src="/static/images/me_construction.png" alt="Walshy in a hard hat" style="width:120px;height:120px;object-fit:cover;border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,0.15);background:#fff"/>
              <div style="width:100%;white-space:pre-wrap;line-height:1.5">
Hello Friend,

Thank you for choosing my app as a possible solution to your EES headache,

I hope you enjoy the app and feel free to look arounf around and let me know if you find anything that looks wierd or buggy.

This calander wil be a masterpice IMO when finished, however, right now tho its not finished. but it will be soon. 

Your friend 



Walshy
              </div>
              <label style="display:flex;align-items:center;gap:8px;margin-top:8px">
                <input id="dontShowSplash" type="checkbox"/>
                <span>Do not show again</span>
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button id="closeSplashBtn" type="button" class="btn btn-primary">Close</button>
          </div>
        </div>`;

      const close = ()=>{
        try{
          const dontShow = (document.getElementById('dontShowSplash') as HTMLInputElement)?.checked;
          if(dontShow){ localStorage.setItem('calendarSplashDismissed_v177','true'); }
        }catch(e){}
        document.body.style.overflow='';
        overlay.remove();
        window.removeEventListener('keydown', onKey);
      };
      const onKey=(e)=>{ if(e.key==='Escape') close(); };

      overlay.querySelector('#closeSplashBtn')?.addEventListener('click', close);
      window.addEventListener('keydown', onKey);
      document.body.appendChild(overlay);
      document.body.style.overflow='hidden';
      setTimeout(()=>overlay.querySelector('#closeSplashBtn')?.focus(),0);
    })();
    </script>
    <script src="{{ url_for('static', filename='js/dragManager.js') }}?v=1.7.8"></script>
    <script src="{{ url_for('static', filename='js/calendar.js') }}?v=1.7.8"></script>
{% endblock %}
