{% extends "base.html" %}

{% block title %}Bulk Add Trip - EU Trip Tracker{% endblock %}

{% block content %}
<div class="content-header">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
        <div>
            <h1 class="content-title">âœˆï¸ Bulk Add Trip</h1>
            <p class="content-subtitle">Add the same trip to multiple employees at once</p>
        </div>
        <div style="display: flex; gap: 12px;">
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9,22 9,12 15,12 15,22"></polyline>
                </svg>
                Back to Dashboard
            </a>
        </div>
    </div>
</div>

<div class="content-body">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">ğŸ“ Trip Details</h2>
        </div>
        
        {% if error %}
        <div class="error-message" style="margin-bottom: 24px;">{{ error }}</div>
        {% endif %}
        
        <form method="POST" id="bulkTripForm">
            <div class="form-inline">
                <div class="form-group">
                    <label class="form-label required">Country</label>
                    <select name="country_code" class="form-select" required>
                        <option value="">Select country</option>
                        <option value="PRIVATE">ğŸ”’ Personal Trip (Dates Only)</option>
                        <option value="AT">ğŸ‡¦ğŸ‡¹ Austria (AT)</option>
                        <option value="BE">ğŸ‡§ğŸ‡ª Belgium (BE)</option>
                        <option value="BG">ğŸ‡§ğŸ‡¬ Bulgaria (BG)</option>
                        <option value="HR">ğŸ‡­ğŸ‡· Croatia (HR)</option>
                        <option value="CY">ğŸ‡¨ğŸ‡¾ Cyprus (CY)</option>
                        <option value="CZ">ğŸ‡¨ğŸ‡¿ Czech Republic (CZ)</option>
                        <option value="DK">ğŸ‡©ğŸ‡° Denmark (DK)</option>
                        <option value="EE">ğŸ‡ªğŸ‡ª Estonia (EE)</option>
                        <option value="FI">ğŸ‡«ğŸ‡® Finland (FI)</option>
                        <option value="FR">ğŸ‡«ğŸ‡· France (FR)</option>
                        <option value="DE">ğŸ‡©ğŸ‡ª Germany (DE)</option>
                        <option value="GR">ğŸ‡¬ğŸ‡· Greece (GR)</option>
                        <option value="HU">ğŸ‡­ğŸ‡º Hungary (HU)</option>
                        <option value="IS">ğŸ‡®ğŸ‡¸ Iceland (IS)</option>
                        <option value="IE">ğŸ‡®ğŸ‡ª Ireland (IE)</option>
                        <option value="IT">ğŸ‡®ğŸ‡¹ Italy (IT)</option>
                        <option value="LV">ğŸ‡±ğŸ‡» Latvia (LV)</option>
                        <option value="LI">ğŸ‡±ğŸ‡® Liechtenstein (LI)</option>
                        <option value="LT">ğŸ‡±ğŸ‡¹ Lithuania (LT)</option>
                        <option value="LU">ğŸ‡±ğŸ‡º Luxembourg (LU)</option>
                        <option value="MT">ğŸ‡²ğŸ‡¹ Malta (MT)</option>
                        <option value="NL">ğŸ‡³ğŸ‡± Netherlands (NL)</option>
                        <option value="NO">ğŸ‡³ğŸ‡´ Norway (NO)</option>
                        <option value="PL">ğŸ‡µğŸ‡± Poland (PL)</option>
                        <option value="PT">ğŸ‡µğŸ‡¹ Portugal (PT)</option>
                        <option value="RO">ğŸ‡·ğŸ‡´ Romania (RO)</option>
                        <option value="SK">ğŸ‡¸ğŸ‡° Slovakia (SK)</option>
                        <option value="SI">ğŸ‡¸ğŸ‡® Slovenia (SI)</option>
                        <option value="ES">ğŸ‡ªğŸ‡¸ Spain (ES)</option>
                        <option value="SE">ğŸ‡¸ğŸ‡ª Sweden (SE)</option>
                        <option value="CH">ğŸ‡¨ğŸ‡­ Switzerland (CH)</option>
                    </select>
                    <div class="form-hint">Select the destination country for all selected employees</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label required">Entry Date</label>
                    <input type="date" name="entry_date" class="form-input" required>
                    <div class="form-hint">Date all employees will enter the country</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label required">Exit Date</label>
                    <input type="date" name="exit_date" class="form-input" required>
                    <div class="form-hint">Date all employees will exit the country</div>
                </div>
            </div>
            
            <div style="margin-top: 32px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="margin: 0; color: #1f2937; font-weight: 600;">Select Employees</h3>
                    <div class="employee-search-container" id="employeeSearchContainer" style="position: relative; width: 300px;">
                        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; color: #9ca3af;">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="M21 21l-4.35-4.35"></path>
                        </svg>
                        <input type="text" id="employeeSearchInput" placeholder="Filter employees..." autocomplete="off" style="width: 100%; padding: 8px 36px 8px 40px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                        <button class="search-clear" id="employeeSearchClear" style="display: none; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #9ca3af; cursor: pointer; font-size: 20px; padding: 4px 8px;">Ã—</button>
                    </div>
                </div>
                
                {% if employees %}
                <div id="employeeGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 12px; margin-bottom: 24px;">
                    {% for emp in employees %}
                    <label class="employee-checkbox" data-employee-name="{{ emp.name|lower }}" style="display: flex; align-items: center; gap: 8px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s; background: var(--base-bg);">
                        <input type="checkbox" name="employee_ids" value="{{ emp.id }}" style="margin: 0;">
                        <span style="font-weight: 500; color: #1f2937;">{{ emp.name }}</span>
                    </label>
                    {% endfor %}
                </div>
                <div id="noEmployeesFound" style="display: none; padding: 24px; text-align: center; color: #6b7280;">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto 12px; color: #d1d5db;">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="M21 21l-4.35-4.35"></path>
                    </svg>
                    <p style="margin: 0; font-weight: 500;">No employees found</p>
                    <p style="margin: 4px 0 0; font-size: 14px; color: #9ca3af;">Try a different search term</p>
                </div>
                
                <div style="display: flex; gap: 12px; align-items: center; justify-content: space-between; flex-wrap: wrap;">
                    <div>
                        <button type="button" onclick="selectAll()" class="btn btn-secondary btn-sm">Select All</button>
                        <button type="button" onclick="selectNone()" class="btn btn-secondary btn-sm">Select None</button>
                    </div>
                    <button type="submit" class="btn btn-primary" id="bulkSubmitBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="8.5" cy="7" r="4"></circle>
                            <line x1="20" y1="8" x2="20" y2="14"></line>
                            <line x1="23" y1="11" x2="17" y2="11"></line>
                        </svg>
                        <span class="btn-text">Add Trip to Selected Employees</span>
                    </button>
                </div>
                {% else %}
                <div class="text-center" style="padding: 40px; color: #6b7280;">
                    <div style="font-size: 48px; margin-bottom: 16px;">ğŸ‘¥</div>
                    <h3 style="color: #1f2937; font-weight: 600; margin-bottom: 8px;">No Employees Found</h3>
                    <p>Add employees first before bulk adding trips</p>
                    <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary" style="margin-top: 16px;">Go to Dashboard</a>
                </div>
                {% endif %}
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function selectAll() {
    const checkboxes = document.querySelectorAll('input[name="employee_ids"]:not([style*="display: none"])');
    checkboxes.forEach(checkbox => {
        const label = checkbox.closest('.employee-checkbox');
        if (label && label.style.display !== 'none') {
            checkbox.checked = true;
        }
    });
}

function selectNone() {
    const checkboxes = document.querySelectorAll('input[name="employee_ids"]');
    checkboxes.forEach(checkbox => checkbox.checked = false);
}

// Employee search/filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const nextWeek = new Date(today);
    nextWeek.setDate(nextWeek.getDate() + 7);
    
    const entryDateInput = document.querySelector('input[name="entry_date"]');
    const exitDateInput = document.querySelector('input[name="exit_date"]');
    if (entryDateInput) entryDateInput.value = today.toISOString().split('T')[0];
    if (exitDateInput) exitDateInput.value = nextWeek.toISOString().split('T')[0];
    
    // Employee filter functionality
    const searchInput = document.getElementById('employeeSearchInput');
    const clearBtn = document.getElementById('employeeSearchClear');
    const employeeGrid = document.getElementById('employeeGrid');
    const noResultsDiv = document.getElementById('noEmployeesFound');
    
    if (searchInput && employeeGrid) {
        let filterTimeout;
        
        searchInput.addEventListener('input', function() {
            clearTimeout(filterTimeout);
            const query = this.value.toLowerCase().trim();
            
            // Show/hide clear button
            if (clearBtn) {
                clearBtn.style.display = query ? 'block' : 'none';
            }
            
            // Debounce the filter (150ms for instant filtering)
            filterTimeout = setTimeout(() => {
                const checkboxes = employeeGrid.querySelectorAll('.employee-checkbox');
                let visibleCount = 0;
                
                checkboxes.forEach(checkbox => {
                    const employeeName = checkbox.getAttribute('data-employee-name') || '';
                    const matches = !query || employeeName.includes(query);
                    
                    checkbox.style.display = matches ? 'flex' : 'none';
                    if (matches) visibleCount++;
                    
                    // Highlight matching text
                    const nameSpan = checkbox.querySelector('span');
                    if (nameSpan && query) {
                        const originalName = nameSpan.textContent;
                        const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
                        nameSpan.innerHTML = originalName.replace(regex, '<mark style="background: #fef3c7; padding: 0 2px; border-radius: 2px;">$1</mark>');
                    } else if (nameSpan) {
                        nameSpan.innerHTML = nameSpan.textContent; // Remove highlights
                    }
                });
                
                // Show/hide no results message
                if (noResultsDiv) {
                    employeeGrid.style.display = visibleCount === 0 ? 'none' : 'grid';
                    noResultsDiv.style.display = visibleCount === 0 ? 'block' : 'none';
                }
            }, 150);
        });
        
        // Clear button functionality
        if (clearBtn) {
            clearBtn.addEventListener('click', function() {
                searchInput.value = '';
                searchInput.dispatchEvent(new Event('input'));
                searchInput.focus();
            });
        }
        
        // Escape key to clear
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                searchInput.value = '';
                searchInput.dispatchEvent(new Event('input'));
                searchInput.blur();
            }
        });
    }
    
    function escapeRegex(str) {
        return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }
    
    // Enhanced form validation and confirmation
    const bulkTripForm = document.getElementById('bulkTripForm');
    const bulkSubmitBtn = document.getElementById('bulkSubmitBtn');
    
    if (bulkTripForm) {
        bulkTripForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get selected employees
            const selectedEmployees = Array.from(document.querySelectorAll('input[name="employee_ids"]:checked'));
            
            if (selectedEmployees.length === 0) {
                showNotification('Please select at least one employee', 'error');
                return false;
            }
            
            // Validate form
            const validation = validateForm(bulkTripForm, {
                dateRange: true
            });
            
            if (!validation.isValid) {
                showNotification(validation.errors.join(', '), 'error');
                return false;
            }
            
            // Show confirmation dialog
            const country = bulkTripForm.querySelector('select[name="country_code"]').selectedOptions[0].text;
            const entryDate = bulkTripForm.querySelector('input[name="entry_date"]').value;
            const exitDate = bulkTripForm.querySelector('input[name="exit_date"]').value;
            
            confirmAction({
                title: 'Confirm Bulk Trip Addition',
                message: `Add trip to ${country} (${entryDate} - ${exitDate}) for ${selectedEmployees.length} employee${selectedEmployees.length !== 1 ? 's' : ''}?`,
                details: `This will add the same trip details to: ${selectedEmployees.map(emp => emp.closest('.employee-checkbox').querySelector('span').textContent).join(', ')}`,
                confirmText: 'Add Trip to All Selected',
                danger: false
            }).then(confirmed => {
                if (confirmed) {
                    // Show loading state
                    setLoadingState(bulkSubmitBtn, true, 'Adding trips...');
                    
                    // Submit the form
                    bulkTripForm.submit();
                }
            });
        });
        
        // Real-time date validation
        const entryDate = bulkTripForm.querySelector('input[name="entry_date"]');
        const exitDate = bulkTripForm.querySelector('input[name="exit_date"]');
        
        function validateDateRange() {
            if (entryDate.value && exitDate.value) {
                const entry = new Date(entryDate.value);
                const exit = new Date(exitDate.value);
                
                if (entry >= exit) {
                    showFieldError(entryDate, 'Entry date must be before exit date');
                    showFieldError(exitDate, 'Exit date must be after entry date');
                } else {
                    // Clear errors if dates are valid
                    entryDate.classList.remove('error');
                    exitDate.classList.remove('error');
                    const errors = bulkTripForm.querySelectorAll('.form-error');
                    errors.forEach(error => error.remove());
                }
            }
        }
        
        entryDate.addEventListener('change', validateDateRange);
        exitDate.addEventListener('change', validateDateRange);
    }
});
</script>
{% endblock %}