{% extends "base.html" %}

{% block title %}Privacy Tools - EU Trip Tracker{% endblock %}

{% block content %}
<div class="content-header">
    <h1 class="content-title">Privacy & DSAR Tools</h1>
    <p class="content-subtitle">Manage data subject access requests and privacy compliance</p>
</div>

<div class="content-body">
    <!-- Employee Search -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Employee Search</h2>
        </div>
        <div class="card-body">
            <div style="display: flex; gap: 12px; align-items: center;">
                <input type="text" id="employeeSearch" placeholder="Search employee by name..." 
                       style="flex: 1; padding: 8px 12px; border: 1px solid #cbd5e0; border-radius: 4px;">
                <button onclick="searchEmployee()" class="btn btn-primary">Search</button>
            </div>
        </div>
    </div>

    <!-- Employee Results -->
    <div id="employeeResults" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Selected Employee</h2>
            </div>
            <div class="card-body">
                <div id="employeeInfo" style="margin-bottom: 20px;"></div>
                
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button onclick="exportEmployeeData()" class="btn btn-primary">
                        ðŸ“¥ Export Data (ZIP)
                    </button>
                    <button onclick="showRectifyModal()" class="btn btn-secondary">
                        Rectify Name
                    </button>
                    <button onclick="anonymizeEmployee()" class="btn btn-secondary">
                        Anonymize
                    </button>
                    <button onclick="showDeleteModal()" class="btn btn-danger">
                        Delete Employee
                    </button>
                    <button onclick="showProcessingInfo()" class="btn btn-secondary">
                        Explain Processing
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Retention Policy -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Retention Policy</h2>
        </div>
        <div class="card-body">
            <p style="margin-bottom: 12px;">
                <strong>Current Retention Period:</strong> {{ retention_months }} months after trip exit date
            </p>
            <p style="margin-bottom: 12px; color: #718096;">
                Trips older than {{ retention_months }} months will be automatically purged.
            </p>
            <p style="margin-bottom: 20px; color: #718096;">
                <strong>Last Purge:</strong> {{ last_purge or 'Never' }}
            </p>
            
            <button onclick="showPurgeConfirm()" class="btn btn-warning">
                Run Retention Purge Now
            </button>
            <a href="{{ url_for('main.admin_settings') }}" class="btn btn-secondary" style="margin-left: 12px;">
                Update Retention Settings
            </a>
        </div>
    </div>

    <!-- Expired Trips Preview -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Trips Pending Deletion</h2>
        </div>
        <div class="card-body">
            <p style="margin-bottom: 12px;">
                <strong>{{ expired_count }}</strong> trip(s) are past the retention period and will be deleted on next purge.
            </p>
            {% if expired_count > 0 %}
                <button onclick="showExpiredTrips()" class="btn btn-secondary">
                    View Expired Trips
                </button>
            {% endif %}
        </div>
    </div>
</div>

<!-- Rectify Modal -->
<div id="rectifyModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Rectify Employee Name</h3>
        <p style="margin: 16px 0;">Current name: <strong id="currentName"></strong></p>
        <div class="form-group">
            <label for="newName" class="form-label">New Name</label>
            <input type="text" id="newName" name="newName" class="form-input" 
                   placeholder="Enter new name..." required minlength="2" maxlength="100"
                   aria-describedby="newName-error newName-help">
            <div id="newName-error" class="invalid-feedback" role="alert"></div>
            <div id="newName-help" class="form-hint">Enter the corrected name (2-100 characters)</div>
        </div>
        <div class="flex flex-justify-end gap-12" style="margin-top: 16px;">
            <button onclick="closeRectifyModal()" class="btn btn-secondary">Cancel</button>
            <button onclick="confirmRectify()" class="btn btn-primary">Update Name</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3 style="color: #e53e3e;">Delete Employee Data</h3>
        <p style="margin: 16px 0;">
            This will <strong>permanently delete</strong> all data for 
            <strong id="deleteEmployeeName"></strong>, including all trip records.
        </p>
        <p style="color: #e53e3e; margin-bottom: 16px;">This action cannot be undone.</p>
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button onclick="closeDeleteModal()" class="btn btn-secondary">Cancel</button>
            <button onclick="confirmDelete()" class="btn btn-danger">Delete All Data</button>
        </div>
    </div>
</div>

<!-- Purge Confirmation Modal -->
<div id="purgeModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3 style="color: #dd6b20;">Run Retention Purge</h3>
        <p style="margin: 16px 0;">
            This will delete all trips older than <strong>{{ retention_months }} months</strong> 
            from their exit date.
        </p>
        <p id="purgePreview" style="margin-bottom: 16px;"></p>
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button onclick="closePurgeModal()" class="btn btn-secondary">Cancel</button>
            <button onclick="confirmPurge()" class="btn btn-warning">Run Purge</button>
        </div>
    </div>
</div>

<!-- Processing Info Modal -->
<div id="processingModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <h3>How We Process Your Data</h3>
        <div style="margin: 16px 0; line-height: 1.6;">
            <h4>What We Store:</h4>
            <ul>
                <li>Your name (for identification)</li>
                <li>Trip records: country, entry date, exit date</li>
            </ul>
            
            <h4>Why We Store It:</h4>
            <p>To track compliance with the Schengen 90/180-day rule for business travel.</p>
            
            <h4>Lawful Basis:</h4>
            <ul>
                <li>Employee data: Legitimate Interests (compliance tracking)</li>
                <li>Trip data: Legal Obligation (Schengen regulation)</li>
            </ul>
            
            <h4>How Long We Keep It:</h4>
            <p>Trips are retained for {{ retention_months }} months after the exit date, then automatically deleted.</p>
            
            <h4>Where It's Stored:</h4>
            <p>Local SQLite database on this server. No cloud storage, no third-party sharing.</p>
            
            <h4>Who Can Access It:</h4>
            <p>Only authorized administrators via password-protected login.</p>
            
            <h4>Your Rights:</h4>
            <ul>
                <li>Access: Request a copy of your data</li>
                <li>Rectification: Update your name</li>
                <li>Erasure: Delete all your data</li>
                <li>Portability: Export in JSON/CSV format</li>
            </ul>
        </div>
        <button onclick="closeProcessingModal()" class="btn btn-primary">Close</button>
    </div>
</div>

<style>
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: var(--base-bg);
    padding: 24px;
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
}

.btn-primary {
    background: #3182ce;
    color: white;
}

.btn-secondary {
    background: #718096;
    color: white;
}

.btn-danger {
    background: #e53e3e;
    color: white;
}

.btn-warning {
    background: #dd6b20;
    color: white;
}
</style>

<script>
let currentEmployeeId = null;
let currentEmployeeName = null;

// Helper function to show notifications
function showNotification(message, type = 'info') {
    if (typeof showSuccess === 'function' && type === 'success') {
        showSuccess(message);
    } else if (typeof showError === 'function' && type === 'error') {
        showError(message);
    } else if (typeof NotificationSystem !== 'undefined') {
        const ns = new NotificationSystem();
        if (type === 'success') {
            ns.showSuccess(message);
        } else if (type === 'error') {
            ns.showError(message);
        } else {
            ns.showInfo(message);
        }
    } else {
        // Fallback to native notification if available
        console.log(`[${type.toUpperCase()}] ${message}`);
    }
    
    // Update aria-live region
    const ariaLive = document.getElementById('aria-live-status');
    if (ariaLive) {
        ariaLive.textContent = message;
    }
}

async function searchEmployee() {
    const searchTerm = document.getElementById('employeeSearch').value.trim();
    if (!searchTerm) {
        showNotification('Please enter an employee name', 'error');
        return;
    }

    try {
        const response = await fetch(`/api/employees/search?q=${encodeURIComponent(searchTerm)}`);
        const data = await response.json();
        
        if (data.error) {
            showNotification(data.error, 'error');
            return;
        }

        if (data.employees && data.employees.length > 0) {
            // Show first match
            const emp = data.employees[0];
            currentEmployeeId = emp.id;
            currentEmployeeName = emp.name;
            
            document.getElementById('employeeInfo').innerHTML = `
                <p><strong>Name:</strong> ${emp.name}</p>
                <p><strong>ID:</strong> ${emp.id}</p>
                <p><strong>Total Trips:</strong> ${emp.trip_count || 0}</p>
            `;
            document.getElementById('employeeResults').style.display = 'block';
            showNotification(`Found employee: ${emp.name}`, 'success');
        } else {
            showNotification('No employee found with that name', 'error');
        }
    } catch (error) {
        showNotification('Error searching employee: ' + error.message, 'error');
    }
}

async function exportEmployeeData() {
    if (!currentEmployeeId) {
        showNotification('Please search and select an employee first', 'error');
        return;
    }
    
    try {
        showNotification('Preparing export...', 'info');
        window.location.href = `/admin/dsar/export/${currentEmployeeId}`;
    } catch (error) {
        showNotification('Error exporting data: ' + error.message, 'error');
    }
}

function showRectifyModal() {
    if (!currentEmployeeId) return;
    document.getElementById('currentName').textContent = currentEmployeeName;
    document.getElementById('newName').value = currentEmployeeName;
    document.getElementById('rectifyModal').style.display = 'flex';
}

function closeRectifyModal() {
    document.getElementById('rectifyModal').style.display = 'none';
}

async function confirmRectify() {
    const input = document.getElementById('newName');
    const errorDiv = document.getElementById('newName-error');
    const newName = input.value.trim();
    
    // Clear previous errors
    input.classList.remove('is-invalid', 'is-valid');
    if (errorDiv) errorDiv.textContent = '';
    
    // Validate
    if (!newName) {
        showNotification('Name cannot be empty', 'error');
        input.classList.add('is-invalid');
        if (errorDiv) errorDiv.textContent = 'Name is required';
        input.focus();
        return;
    }
    
    if (newName.length < 2) {
        showNotification('Name must be at least 2 characters', 'error');
        input.classList.add('is-invalid');
        if (errorDiv) errorDiv.textContent = 'Name must be at least 2 characters';
        input.focus();
        return;
    }
    
    if (newName.length > 100) {
        showNotification('Name must be no more than 100 characters', 'error');
        input.classList.add('is-invalid');
        if (errorDiv) errorDiv.textContent = 'Name must be no more than 100 characters';
        input.focus();
        return;
    }

    try {
        const response = await fetch(`/admin/dsar/rectify/${currentEmployeeId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({new_name: newName})
        });
        
        const data = await response.json();
        if (data.success) {
            input.classList.add('is-valid');
            showNotification('Name updated successfully', 'success');
            currentEmployeeName = newName;
            document.getElementById('employeeInfo').innerHTML = `
                <p><strong>Name:</strong> ${newName}</p>
                <p><strong>ID:</strong> ${currentEmployeeId}</p>
            `;
            closeRectifyModal();
        } else {
            input.classList.add('is-invalid');
            const errorMsg = data.error || 'Unknown error';
            showNotification('Error: ' + errorMsg, 'error');
            const errorDiv = document.getElementById('newName-error');
            if (errorDiv) errorDiv.textContent = errorMsg;
        }
    } catch (error) {
        input.classList.add('is-invalid');
        showNotification('Error updating name: ' + error.message, 'error');
        const errorDiv = document.getElementById('newName-error');
        if (errorDiv) errorDiv.textContent = error.message;
    }
}

function showDeleteModal() {
    if (!currentEmployeeId) return;
    document.getElementById('deleteEmployeeName').textContent = currentEmployeeName;
    document.getElementById('deleteModal').style.display = 'flex';
}

function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
}

async function confirmDelete() {
    try {
        const response = await fetch(`/admin/dsar/delete/${currentEmployeeId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        if (data.success) {
            showNotification('Employee data deleted successfully', 'success');
            closeDeleteModal();
            document.getElementById('employeeResults').style.display = 'none';
            document.getElementById('employeeSearch').value = '';
            currentEmployeeId = null;
            currentEmployeeName = null;
        } else {
            showNotification('Error: ' + (data.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showNotification('Error deleting employee: ' + error.message, 'error');
    }
}

async function anonymizeEmployee() {
    if (!currentEmployeeId) return;
    
    if (!confirm(`Anonymize ${currentEmployeeName}? This will replace their name with "Employee #${String(currentEmployeeId).padStart(4, '0')}"`)) {
        return;
    }

    try {
        const response = await fetch(`/admin/dsar/anonymize/${currentEmployeeId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        if (data.success) {
            showNotification('Employee anonymized successfully', 'success');
            currentEmployeeName = data.new_name;
            document.getElementById('employeeInfo').innerHTML = `
                <p><strong>Name:</strong> ${data.new_name}</p>
                <p><strong>ID:</strong> ${currentEmployeeId}</p>
            `;
        } else {
            showNotification('Error: ' + (data.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showNotification('Error anonymizing employee: ' + error.message, 'error');
    }
}

function showProcessingInfo() {
    document.getElementById('processingModal').style.display = 'flex';
}

function closeProcessingModal() {
    document.getElementById('processingModal').style.display = 'none';
}

async function showPurgeConfirm() {
    try {
        const response = await fetch('/api/retention/preview');
        const data = await response.json();
        
        document.getElementById('purgePreview').innerHTML = `
            <strong>${data.trips_count || 0}</strong> trip(s) will be deleted<br>
            <strong>${data.employees_affected || 0}</strong> employee(s) affected
        `;
        document.getElementById('purgeModal').style.display = 'flex';
    } catch (error) {
        showNotification('Error loading purge preview: ' + error.message, 'error');
    }
}

function closePurgeModal() {
    document.getElementById('purgeModal').style.display = 'none';
}

async function confirmPurge() {
    try {
        const response = await fetch('/admin/retention/purge', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        if (data.success) {
            showNotification(`Purge complete: ${data.trips_deleted} trips deleted, ${data.employees_deleted} employees deleted`, 'success');
            closePurgeModal();
            window.location.reload();
        } else {
            showNotification('Error: ' + (data.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showNotification('Error running purge: ' + error.message, 'error');
    }
}

async function showExpiredTrips() {
    window.location.href = '/admin/retention/expired';
}

// Allow Enter key in search
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('employeeSearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchEmployee();
        }
    });
});
</script>
{% endblock %}

