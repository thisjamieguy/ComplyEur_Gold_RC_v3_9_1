{% extends "base.html" %}

{% block title %}{{ employee.name }} - EU Trip Tracker{% endblock %}

{% block content %}
<div class="content-header">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
        <div>
            <h1 class="content-title">{{ employee.name }}</h1>
            <p class="content-subtitle">Employee trip history and compliance tracking</p>
        </div>
        <div style="display: flex; gap: 12px;">
            <a href="{{ url_for('calendar', employee_id=employee.id) }}" class="btn btn-secondary">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                Calendar View
            </a>
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9,22 9,12 15,12 15,22"></polyline>
                </svg>
                Back to Dashboard
            </a>
        </div>
    </div>
</div>

<div class="content-body">
    <!-- Status Alert -->
    {% if days_used >= 90 %}
    <div class="card" style="border-left: 4px solid #ef4444; background: #fef2f2;">
        <div style="padding: 12px;">
            <h3 style="color: #991b1b; font-weight: 600; margin: 0 0 4px 0;">Over 90-Day Limit</h3>
                <p style="color: #991b1b; margin: 0;">
                    This employee has used {{ days_used }} days in the last 180 days, exceeding the 90-day limit.
                    {% if days_until_safe %}
                    They will be compliant again in {{ days_until_safe }} days.
                    {% endif %}
                </p>
        </div>
    </div>
    {% elif days_used > 80 %}
    <div class="card" style="border-left: 4px solid #f59e0b; background: #fffbeb;">
        <div style="padding: 12px;">
            <h3 style="color: #92400e; font-weight: 600; margin: 0 0 4px 0;">Approaching Limit</h3>
            <p style="color: #92400e; margin: 0;">
                This employee has used {{ days_used }} days in the last 180 days. Only {{ 90 - days_used }} days remaining.
            </p>
        </div>
    </div>
    {% endif %}

    <!-- Summary Stats -->
    <div class="grid grid-3">
        <div class="card text-center">
            <div style="font-size: 36px; font-weight: 700; color: {% if risk_level == 'red' %}#ef4444{% elif risk_level == 'amber' %}#f59e0b{% else %}#10b981{% endif %}; margin-bottom: 8px;">
                {{ days_used }}
            </div>
            <div class="text-muted" style="font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                Days Used (180d)
            </div>
            <div style="margin-top: 12px; background: #e5e7eb; height: 10px; border-radius: 5px; overflow: hidden;">
                <div style="height: 100%; width: {{ (days_used / 90 * 100)|round }}%; background: {% if risk_level == 'red' %}#ef4444{% elif risk_level == 'amber' %}#f59e0b{% else %}#10b981{% endif %}; transition: all 0.3s;"></div>
            </div>
        </div>
        
        <div class="card text-center">
            <div style="font-size: 36px; font-weight: 700; color: {% if risk_level == 'red' %}#ef4444{% elif risk_level == 'amber' %}#f59e0b{% else %}#10b981{% endif %}; margin-bottom: 8px;">
                {{ days_remaining }}
            </div>
            <div class="text-muted" style="font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                Days Remaining
            </div>
            <div style="margin-top: 12px; font-size: 14px; color: #6b7280;">
                {% if risk_level == 'red' %}
                    <span style="color: #ef4444; font-weight: 600;">High Risk</span>
                {% elif risk_level == 'amber' %}
                    <span style="color: #f59e0b; font-weight: 600;">Caution</span>
                {% else %}
                    <span style="color: #10b981; font-weight: 600;">Safe</span>
                {% endif %}
            </div>
        </div>
        
        <div class="card text-center">
            {% if earliest_safe_entry %}
                <div style="font-size: 28px; font-weight: 700; color: #f59e0b; margin-bottom: 8px;">
                    {{ earliest_safe_entry|uk_date }}
                </div>
                <div class="text-muted" style="font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                    Earliest Safe Entry
                </div>
                <div style="margin-top: 12px; font-size: 14px; color: #6b7280;">
                    {% if days_until_safe %}
                        In {{ days_until_safe }} days
                    {% endif %}
                </div>
            {% else %}
                <div style="font-size: 28px; font-weight: 700; color: #10b981; margin-bottom: 8px;">
                    Eligible
                </div>
                <div class="text-muted" style="font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                    Can Enter Now
                </div>
                <div style="margin-top: 12px; font-size: 14px; color: #10b981; font-weight: 600;">
                    Available
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Add Trip Form -->
    <div class="card" id="trip-warnings">
        <div class="card-header">
            <h2 class="card-title">Add New Trip</h2>
        </div>
        
        {% if session.get('pending_trip') and session.pending_trip.employee_id|int == employee.id %}
        <div style="background: #fffbeb; border-left: 4px solid #f59e0b; padding: 16px; margin: 16px; border-radius: 4px;">
            <div style="padding: 12px;">
                <h3 style="color: #92400e; font-weight: 600; margin: 0 0 8px 0;">Trip Validation Warnings</h3>
                    <ul style="margin: 0 0 12px 20px; color: #92400e;">
                        {% for warning in session.pending_trip.warnings %}
                        <li>{{ warning }}</li>
                        {% endfor %}
                    </ul>
                    <p style="color: #92400e; margin: 0 0 12px 0;">
                        You can override these warnings by providing a reason and clicking "Add Trip Anyway".
                    </p>
                    <form method="POST" action="{{ url_for('add_trip') }}" style="display: flex; gap: 12px; align-items: end;">
                        <input type="hidden" name="employee_id" value="{{ employee.id }}">
                        <input type="hidden" name="country_code" value="{{ session.pending_trip.country_code }}">
                        <input type="hidden" name="entry_date" value="{{ session.pending_trip.entry_date }}">
                        <input type="hidden" name="exit_date" value="{{ session.pending_trip.exit_date }}">
                        <input type="hidden" name="override_validation" value="true">
                        <div style="flex: 1;">
                            <label style="display: block; font-size: 13px; color: #92400e; margin-bottom: 4px;">Override Reason:</label>
                            <input type="text" name="validation_note" class="form-input" placeholder="e.g., Emergency travel, Business critical" required style="width: 100%;">
                        </div>
                        <button type="submit" class="btn" style="background: #f59e0b; color: white;">Add Trip Anyway</button>
                        <a href="{{ url_for('employee_detail', employee_id=employee.id) }}" class="btn btn-outline">Cancel</a>
                    </form>
            </div>
        </div>
        {% endif %}
        
        <form method="POST" action="{{ url_for('add_trip') }}">
            <input type="hidden" name="employee_id" value="{{ employee.id }}">
            
            <div class="form-inline">
                <div class="form-group">
                    <label class="form-label">Country</label>
                    <div class="dropdown-container">
                        <input type="text" name="country_display" class="form-input dropdown-input" placeholder="Select country" required readonly onclick="toggleDropdown('countryDropdown')">
                        <div class="dropdown-arrow">â–¼</div>
                        <div id="countryDropdown" class="dropdown-list">
                            <div class="dropdown-item" onclick="selectCountry('Austria', 'AT')">ðŸ‡¦ðŸ‡¹ Austria (AT)</div>
                            <div class="dropdown-item" onclick="selectCountry('Belgium', 'BE')">ðŸ‡§ðŸ‡ª Belgium (BE)</div>
                            <div class="dropdown-item" onclick="selectCountry('Bulgaria', 'BG')">ðŸ‡§ðŸ‡¬ Bulgaria (BG)</div>
                            <div class="dropdown-item" onclick="selectCountry('Croatia', 'HR')">ðŸ‡­ðŸ‡· Croatia (HR)</div>
                            <div class="dropdown-item" onclick="selectCountry('Cyprus', 'CY')">ðŸ‡¨ðŸ‡¾ Cyprus (CY)</div>
                            <div class="dropdown-item" onclick="selectCountry('Czech Republic', 'CZ')">ðŸ‡¨ðŸ‡¿ Czech Republic (CZ)</div>
                            <div class="dropdown-item" onclick="selectCountry('Denmark', 'DK')">ðŸ‡©ðŸ‡° Denmark (DK)</div>
                            <div class="dropdown-item" onclick="selectCountry('Estonia', 'EE')">ðŸ‡ªðŸ‡ª Estonia (EE)</div>
                            <div class="dropdown-item" onclick="selectCountry('Finland', 'FI')">ðŸ‡«ðŸ‡® Finland (FI)</div>
                            <div class="dropdown-item" onclick="selectCountry('France', 'FR')">ðŸ‡«ðŸ‡· France (FR)</div>
                            <div class="dropdown-item" onclick="selectCountry('Germany', 'DE')">ðŸ‡©ðŸ‡ª Germany (DE)</div>
                            <div class="dropdown-item" onclick="selectCountry('Greece', 'GR')">ðŸ‡¬ðŸ‡· Greece (GR)</div>
                            <div class="dropdown-item" onclick="selectCountry('Hungary', 'HU')">ðŸ‡­ðŸ‡º Hungary (HU)</div>
                            <div class="dropdown-item" onclick="selectCountry('Iceland', 'IS')">ðŸ‡®ðŸ‡¸ Iceland (IS)</div>
                            <div class="dropdown-item" onclick="selectCountry('Ireland', 'IE')">ðŸ‡®ðŸ‡ª Ireland (IE)</div>
                            <div class="dropdown-item" onclick="selectCountry('Italy', 'IT')">ðŸ‡®ðŸ‡¹ Italy (IT)</div>
                            <div class="dropdown-item" onclick="selectCountry('Latvia', 'LV')">ðŸ‡±ðŸ‡» Latvia (LV)</div>
                            <div class="dropdown-item" onclick="selectCountry('Liechtenstein', 'LI')">ðŸ‡±ðŸ‡® Liechtenstein (LI)</div>
                            <div class="dropdown-item" onclick="selectCountry('Lithuania', 'LT')">ðŸ‡±ðŸ‡¹ Lithuania (LT)</div>
                            <div class="dropdown-item" onclick="selectCountry('Luxembourg', 'LU')">ðŸ‡±ðŸ‡º Luxembourg (LU)</div>
                            <div class="dropdown-item" onclick="selectCountry('Malta', 'MT')">ðŸ‡²ðŸ‡¹ Malta (MT)</div>
                            <div class="dropdown-item" onclick="selectCountry('Netherlands', 'NL')">ðŸ‡³ðŸ‡± Netherlands (NL)</div>
                            <div class="dropdown-item" onclick="selectCountry('Norway', 'NO')">ðŸ‡³ðŸ‡´ Norway (NO)</div>
                            <div class="dropdown-item" onclick="selectCountry('Poland', 'PL')">ðŸ‡µðŸ‡± Poland (PL)</div>
                            <div class="dropdown-item" onclick="selectCountry('Portugal', 'PT')">ðŸ‡µðŸ‡¹ Portugal (PT)</div>
                            <div class="dropdown-item" onclick="selectCountry('Romania', 'RO')">ðŸ‡·ðŸ‡´ Romania (RO)</div>
                            <div class="dropdown-item" onclick="selectCountry('Slovakia', 'SK')">ðŸ‡¸ðŸ‡° Slovakia (SK)</div>
                            <div class="dropdown-item" onclick="selectCountry('Slovenia', 'SI')">ðŸ‡¸ðŸ‡® Slovenia (SI)</div>
                            <div class="dropdown-item" onclick="selectCountry('Spain', 'ES')">ðŸ‡ªðŸ‡¸ Spain (ES)</div>
                            <div class="dropdown-item" onclick="selectCountry('Sweden', 'SE')">ðŸ‡¸ðŸ‡ª Sweden (SE)</div>
                            <div class="dropdown-item" onclick="selectCountry('Switzerland', 'CH')">ðŸ‡¨ðŸ‡­ Switzerland (CH)</div>
                        </div>
                    </div>
                </div>
                <input type="hidden" name="country_code" id="country_code" value="">
                
                <div class="form-group">
                    <label class="form-label">Entry Date</label>
                    <input type="date" name="entry_date" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Exit Date</label>
                    <input type="date" name="exit_date" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn btn-primary" style="margin-top: 24px;">Add Trip</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Trip Planning Tool -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Trip Planning Tool</h2>
        </div>
        <p class="text-muted" style="margin-bottom: 20px;">
            Plan a future trip to see how it would affect your 90-day limit without adding it to your record.
        </p>
        
        <div class="form-inline">
            <div class="form-group">
                <label class="form-label">Planned Country</label>
                <input type="text" id="planCountry" class="form-input" placeholder="Enter country">
            </div>
            <div class="form-group">
                <label class="form-label">Entry Date</label>
                <input type="date" id="planEntryDate" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Exit Date</label>
                <input type="date" id="planExitDate" class="form-input">
            </div>
            <div class="form-group">
                <button onclick="planTrip()" class="btn btn-outline" style="margin-top: 24px;">Plan Trip</button>
            </div>
        </div>
        
        <div id="tripPlanResult" style="display: none; margin-top: 20px;"></div>
    </div>

    <!-- Trip History -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Trip History</h2>
        </div>
        
        {% if trips %}
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Country</th>
                        <th>Entry Date</th>
                        <th>Exit Date</th>
                        <th>Duration</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trip in trips %}
                    <tr>
                        <td style="font-weight: 500;">
                            {{ trip.country|country_name }}
                            {% if trip.country|is_ireland %}
                                <br><small style="color: #9ca3af; font-size: 11px;">(Non-Schengen)</small>
                            {% endif %}
                            {% if trip.validation_note %}
                                <br><small style="color: #f59e0b; font-size: 11px;" title="Validation override: {{ trip.validation_note }}">Override</small>
                            {% endif %}
                        </td>
                        <td>{{ trip.entry_date|uk_date }}</td>
                        <td>{{ trip.exit_date|uk_date }}</td>
                        <td>
                            {{ trip.duration }} day{% if trip.duration != 1 %}s{% endif %}
                            {% if trip.travel_days and trip.travel_days > 0 %}
                                <br><small class="text-muted">({{ trip.travel_days }} travel day{% if trip.travel_days != 1 %}s{% endif %})</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if trip.status == 'completed' %}
                                <span class="status-badge status-safe">Completed</span>
                            {% elif trip.status == 'current' %}
                                <span class="status-badge status-warning">Current</span>
                            {% else %}
                                <span class="status-badge" style="background: #f0f9ff; color: #1e40af;">Future</span>
                            {% endif %}
                        </td>
                        <td>
                            <form method="POST" action="{{ url_for('delete_trip', trip_id=trip.id) }}" style="display: inline;">
                                <input type="hidden" name="employee_id" value="{{ employee.id }}">
                                <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this trip?')">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3,6 5,6 21,6"></polyline>
                                        <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"></path>
                                    </svg>
                                    Delete
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% if trip.validation_note %}
                    <tr>
                        <td colspan="6" style="background: #fffbeb; padding: 8px 16px; border-left: 4px solid #f59e0b;">
                            <small style="color: #92400e;">
                                <strong>Override Reason:</strong> {{ trip.validation_note }}
                            </small>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center" style="padding: 40px;">
            <h3 style="color: #1f2937; font-weight: 600; margin-bottom: 8px;">No Trips Yet</h3>
            <p class="text-muted">Add the first trip using the form above</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Country dropdown functionality
function toggleDropdown(dropdownId) {
    const dropdown = document.getElementById(dropdownId);
    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
}

function selectCountry(country, code) {
    document.querySelector('input[name="country_display"]').value = country;
    document.getElementById('country_code').value = code;
    document.getElementById('countryDropdown').style.display = 'none';
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.dropdown-container')) {
        document.getElementById('countryDropdown').style.display = 'none';
    }
});

// Trip planning functionality
function planTrip() {
    const country = document.getElementById('planCountry').value;
    const entryDate = document.getElementById('planEntryDate').value;
    const exitDate = document.getElementById('planExitDate').value;
    
    if (!country || !entryDate || !exitDate) {
        alert('Please fill in all fields');
        return;
    }
    
    if (new Date(exitDate) <= new Date(entryDate)) {
        alert('Exit date must be after entry date');
        return;
    }
    
    // Calculate trip duration
    const entry = new Date(entryDate);
    const exit = new Date(exitDate);
    const duration = Math.ceil((exit - entry) / (1000 * 60 * 60 * 24)) + 1;
    
    // Send request to forecast endpoint
    fetch('/forecast-trip', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            employee_id: {{ employee.id }},
            country: country,
            entry_date: entryDate,
            exit_date: exitDate
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }
        
        const resultDiv = document.getElementById('tripPlanResult');
        resultDiv.style.display = 'block';
        
        let statusClass = '';
        if (data.status === 'over_limit') {
            statusClass = 'status-danger';
        } else if (data.status === 'warning') {
            statusClass = 'status-warning';
        } else {
            statusClass = 'status-safe';
        }
        
        resultDiv.innerHTML = `
            <div class="card ${statusClass}" style="padding: 20px;">
                <h3 style="margin: 0 0 12px 0;">Trip Forecast</h3>
                <p style="margin: 0 0 12px 0; font-weight: 500;">${data.message}</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-top: 16px;">
                    <div>
                        <div style="font-size: 24px; font-weight: 700; color: #6b7280;">${data.current_days_used}</div>
                        <div style="font-size: 12px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Current Days</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: 700; color: #6b7280;">${duration}</div>
                        <div style="font-size: 12px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Trip Duration</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: 700; color: #6b7280;">${data.total_days_after}</div>
                        <div style="font-size: 12px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Total After Trip</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: 700; color: #6b7280;">${data.remaining_days}</div>
                        <div style="font-size: 12px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Days Remaining</div>
                    </div>
                </div>
            </div>
        `;
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while planning the trip');
    });
}

// Set default dates for trip planning
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    const nextWeek = new Date(today);
    nextWeek.setDate(nextWeek.getDate() + 7);
    
    document.getElementById('planEntryDate').value = tomorrow.toISOString().split('T')[0];
    document.getElementById('planExitDate').value = nextWeek.toISOString().split('T')[0];
});
</script>

<style>
.dropdown-container { position: relative; }
.dropdown-input {
    width: 100%;
    padding: 12px 44px 12px 16px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    background: var(--base-bg);
    font-family: inherit;
    transition: all 0.2s;
}
.dropdown-input:focus {
    outline: none;
    border-color: #f97316;
    box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
}
.dropdown-list {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--base-bg);
    border: 1px solid #e5e7eb;
    border-top: none;
    border-radius: 0 0 8px 8px;
    max-height: 240px;
    overflow-y: auto;
    z-index: 100;
    display: none;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}
.dropdown-item {
    padding: 12px 16px;
    cursor: pointer;
    border-bottom: 1px solid #e5e7eb;
    color: #6b7280;
    transition: background-color 0.15s;
    display: flex;
    align-items: center;
    gap: 8px;
}
.dropdown-item:hover {
    background: #f9fafb;
    color: #f97316;
}
.dropdown-item:last-child { border-bottom: none; }
.dropdown-arrow {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: #6b7280;
    pointer-events: none;
    font-size: 12px;
}
</style>
{% endblock %}