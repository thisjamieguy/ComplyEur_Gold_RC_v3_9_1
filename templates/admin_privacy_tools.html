{% extends "base.html" %}

{% block title %}Privacy Tools - EU Trip Tracker{% endblock %}

{% block content %}
<div class="content-header">
    <h1 class="content-title">Privacy & DSAR Tools</h1>
    <p class="content-subtitle">Manage data subject access requests and privacy compliance</p>
</div>

<div class="content-body">
    <!-- Employee Search -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Employee Search</h2>
        </div>
        <div class="card-body">
            <div style="display: flex; gap: 12px; align-items: center;">
                <input type="text" id="employeeSearch" placeholder="Search employee by name..." 
                       style="flex: 1; padding: 8px 12px; border: 1px solid #cbd5e0; border-radius: 4px;">
                <button onclick="searchEmployee()" class="btn btn-primary">Search</button>
            </div>
        </div>
    </div>

    <!-- Employee Results -->
    <div id="employeeResults" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Selected Employee</h2>
            </div>
            <div class="card-body">
                <div id="employeeInfo" style="margin-bottom: 20px;"></div>
                
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button onclick="exportEmployeeData()" class="btn btn-primary">
                        üì• Export Data (ZIP)
                    </button>
                    <button onclick="showRectifyModal()" class="btn btn-secondary">
                        ‚úèÔ∏è Rectify Name
                    </button>
                    <button onclick="anonymizeEmployee()" class="btn btn-secondary">
                        üîí Anonymize
                    </button>
                    <button onclick="showDeleteModal()" class="btn btn-danger">
                        üóëÔ∏è Delete Employee
                    </button>
                    <button onclick="showProcessingInfo()" class="btn btn-secondary">
                        ‚ÑπÔ∏è Explain Processing
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Retention Policy -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Retention Policy</h2>
        </div>
        <div class="card-body">
            <p style="margin-bottom: 12px;">
                <strong>Current Retention Period:</strong> {{ retention_months }} months after trip exit date
            </p>
            <p style="margin-bottom: 12px; color: #718096;">
                Trips older than {{ retention_months }} months will be automatically purged.
            </p>
            <p style="margin-bottom: 20px; color: #718096;">
                <strong>Last Purge:</strong> {{ last_purge or 'Never' }}
            </p>
            
            <button onclick="showPurgeConfirm()" class="btn btn-warning">
                üóëÔ∏è Run Retention Purge Now
            </button>
            <a href="{{ url_for('admin_settings') }}" class="btn btn-secondary" style="margin-left: 12px;">
                ‚öôÔ∏è Update Retention Settings
            </a>
        </div>
    </div>

    <!-- Expired Trips Preview -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Trips Pending Deletion</h2>
        </div>
        <div class="card-body">
            <p style="margin-bottom: 12px;">
                <strong>{{ expired_count }}</strong> trip(s) are past the retention period and will be deleted on next purge.
            </p>
            {% if expired_count > 0 %}
                <button onclick="showExpiredTrips()" class="btn btn-secondary">
                    View Expired Trips
                </button>
            {% endif %}
        </div>
    </div>
</div>

<!-- Rectify Modal -->
<div id="rectifyModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Rectify Employee Name</h3>
        <p style="margin: 16px 0;">Current name: <strong id="currentName"></strong></p>
        <input type="text" id="newName" placeholder="Enter new name..." 
               style="width: 100%; padding: 8px 12px; border: 1px solid #cbd5e0; border-radius: 4px; margin-bottom: 16px;">
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button onclick="closeRectifyModal()" class="btn btn-secondary">Cancel</button>
            <button onclick="confirmRectify()" class="btn btn-primary">Update Name</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3 style="color: #e53e3e;">‚ö†Ô∏è Delete Employee Data</h3>
        <p style="margin: 16px 0;">
            This will <strong>permanently delete</strong> all data for 
            <strong id="deleteEmployeeName"></strong>, including all trip records.
        </p>
        <p style="color: #e53e3e; margin-bottom: 16px;">This action cannot be undone.</p>
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button onclick="closeDeleteModal()" class="btn btn-secondary">Cancel</button>
            <button onclick="confirmDelete()" class="btn btn-danger">Delete All Data</button>
        </div>
    </div>
</div>

<!-- Purge Confirmation Modal -->
<div id="purgeModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3 style="color: #dd6b20;">‚ö†Ô∏è Run Retention Purge</h3>
        <p style="margin: 16px 0;">
            This will delete all trips older than <strong>{{ retention_months }} months</strong> 
            from their exit date.
        </p>
        <p id="purgePreview" style="margin-bottom: 16px;"></p>
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button onclick="closePurgeModal()" class="btn btn-secondary">Cancel</button>
            <button onclick="confirmPurge()" class="btn btn-warning">Run Purge</button>
        </div>
    </div>
</div>

<!-- Processing Info Modal -->
<div id="processingModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <h3>How We Process Your Data</h3>
        <div style="margin: 16px 0; line-height: 1.6;">
            <h4>What We Store:</h4>
            <ul>
                <li>Your name (for identification)</li>
                <li>Trip records: country, entry date, exit date</li>
            </ul>
            
            <h4>Why We Store It:</h4>
            <p>To track compliance with the Schengen 90/180-day rule for business travel.</p>
            
            <h4>Lawful Basis:</h4>
            <ul>
                <li>Employee data: Legitimate Interests (compliance tracking)</li>
                <li>Trip data: Legal Obligation (Schengen regulation)</li>
            </ul>
            
            <h4>How Long We Keep It:</h4>
            <p>Trips are retained for {{ retention_months }} months after the exit date, then automatically deleted.</p>
            
            <h4>Where It's Stored:</h4>
            <p>Local SQLite database on this server. No cloud storage, no third-party sharing.</p>
            
            <h4>Who Can Access It:</h4>
            <p>Only authorized administrators via password-protected login.</p>
            
            <h4>Your Rights:</h4>
            <ul>
                <li>Access: Request a copy of your data</li>
                <li>Rectification: Update your name</li>
                <li>Erasure: Delete all your data</li>
                <li>Portability: Export in JSON/CSV format</li>
            </ul>
        </div>
        <button onclick="closeProcessingModal()" class="btn btn-primary">Close</button>
    </div>
</div>

<style>
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: var(--base-bg);
    padding: 24px;
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
}

.btn-primary {
    background: #3182ce;
    color: white;
}

.btn-secondary {
    background: #718096;
    color: white;
}

.btn-danger {
    background: #e53e3e;
    color: white;
}

.btn-warning {
    background: #dd6b20;
    color: white;
}
</style>

<script>
let currentEmployeeId = null;
let currentEmployeeName = null;

async function searchEmployee() {
    const searchTerm = document.getElementById('employeeSearch').value.trim();
    if (!searchTerm) {
        alert('Please enter an employee name');
        return;
    }

    try {
        const response = await fetch(`/api/employees/search?q=${encodeURIComponent(searchTerm)}`);
        const data = await response.json();
        
        if (data.error) {
            alert(data.error);
            return;
        }

        if (data.employees && data.employees.length > 0) {
            // Show first match
            const emp = data.employees[0];
            currentEmployeeId = emp.id;
            currentEmployeeName = emp.name;
            
            document.getElementById('employeeInfo').innerHTML = `
                <p><strong>Name:</strong> ${emp.name}</p>
                <p><strong>ID:</strong> ${emp.id}</p>
                <p><strong>Total Trips:</strong> ${emp.trip_count || 0}</p>
            `;
            document.getElementById('employeeResults').style.display = 'block';
        } else {
            alert('No employee found with that name');
        }
    } catch (error) {
        alert('Error searching employee: ' + error.message);
    }
}

async function exportEmployeeData() {
    if (!currentEmployeeId) return;
    
    try {
        window.location.href = `/admin/dsar/export/${currentEmployeeId}`;
    } catch (error) {
        alert('Error exporting data: ' + error.message);
    }
}

function showRectifyModal() {
    if (!currentEmployeeId) return;
    document.getElementById('currentName').textContent = currentEmployeeName;
    document.getElementById('newName').value = currentEmployeeName;
    document.getElementById('rectifyModal').style.display = 'flex';
}

function closeRectifyModal() {
    document.getElementById('rectifyModal').style.display = 'none';
}

async function confirmRectify() {
    const newName = document.getElementById('newName').value.trim();
    if (!newName) {
        alert('Name cannot be empty');
        return;
    }

    try {
        const response = await fetch(`/admin/dsar/rectify/${currentEmployeeId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({new_name: newName})
        });
        
        const data = await response.json();
        if (data.success) {
            alert('Name updated successfully');
            currentEmployeeName = newName;
            document.getElementById('employeeInfo').innerHTML = `
                <p><strong>Name:</strong> ${newName}</p>
                <p><strong>ID:</strong> ${currentEmployeeId}</p>
            `;
            closeRectifyModal();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error updating name: ' + error.message);
    }
}

function showDeleteModal() {
    if (!currentEmployeeId) return;
    document.getElementById('deleteEmployeeName').textContent = currentEmployeeName;
    document.getElementById('deleteModal').style.display = 'flex';
}

function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
}

async function confirmDelete() {
    try {
        const response = await fetch(`/admin/dsar/delete/${currentEmployeeId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        if (data.success) {
            alert('Employee data deleted successfully');
            closeDeleteModal();
            document.getElementById('employeeResults').style.display = 'none';
            document.getElementById('employeeSearch').value = '';
            currentEmployeeId = null;
            currentEmployeeName = null;
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error deleting employee: ' + error.message);
    }
}

async function anonymizeEmployee() {
    if (!currentEmployeeId) return;
    
    if (!confirm(`Anonymize ${currentEmployeeName}? This will replace their name with "Employee #${String(currentEmployeeId).padStart(4, '0')}"`)) {
        return;
    }

    try {
        const response = await fetch(`/admin/dsar/anonymize/${currentEmployeeId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        if (data.success) {
            alert('Employee anonymized successfully');
            currentEmployeeName = data.new_name;
            document.getElementById('employeeInfo').innerHTML = `
                <p><strong>Name:</strong> ${data.new_name}</p>
                <p><strong>ID:</strong> ${currentEmployeeId}</p>
            `;
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error anonymizing employee: ' + error.message);
    }
}

function showProcessingInfo() {
    document.getElementById('processingModal').style.display = 'flex';
}

function closeProcessingModal() {
    document.getElementById('processingModal').style.display = 'none';
}

async function showPurgeConfirm() {
    try {
        const response = await fetch('/api/retention/preview');
        const data = await response.json();
        
        document.getElementById('purgePreview').innerHTML = `
            <strong>${data.trips_count || 0}</strong> trip(s) will be deleted<br>
            <strong>${data.employees_affected || 0}</strong> employee(s) affected
        `;
        document.getElementById('purgeModal').style.display = 'flex';
    } catch (error) {
        alert('Error loading purge preview: ' + error.message);
    }
}

function closePurgeModal() {
    document.getElementById('purgeModal').style.display = 'none';
}

async function confirmPurge() {
    try {
        const response = await fetch('/admin/retention/purge', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        if (data.success) {
            alert(`Purge complete:\n${data.trips_deleted} trips deleted\n${data.employees_deleted} employees deleted`);
            closePurgeModal();
            window.location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error running purge: ' + error.message);
    }
}

async function showExpiredTrips() {
    window.location.href = '/admin/retention/expired';
}

// Allow Enter key in search
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('employeeSearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchEmployee();
        }
    });
});
</script>
{% endblock %}

