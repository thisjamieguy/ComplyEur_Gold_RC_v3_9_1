# ComplyEur Testing Guide

**Version**: 3.9.1 (Gold Release Candidate)  
**Last Updated**: 2025-11-12

This document provides comprehensive instructions for running the ComplyEur test suite.

---

## Test Suite Overview

ComplyEur includes multiple test suites:

1. **Unit Tests** (Python/Pytest) - Core logic and services
2. **Integration Tests** (Python/Pytest) - End-to-end functionality
3. **Playwright Tests** (TypeScript/JavaScript) - Browser automation and UI testing
4. **Excel Import Tests** - File upload and data validation

---

## Prerequisites

### Python Testing
- Python 3.9+
- Virtual environment activated
- All dependencies installed (`pip install -r requirements.txt`)

### Playwright Testing
- Node.js 16+ installed
- npm dependencies installed (`npm install`)
- Playwright browsers installed (`npx playwright install`)

---

## Running Tests

### Quick Start

**Run all Python tests:**
```bash
pytest tests/ -v
```

**Run all Playwright tests:**
```bash
npm run test:qa
# or
npx playwright test
```

---

## Python Test Suite

### Test Structure

```
tests/
├── test_app.py              # Main application tests
├── test_rolling90.py        # 90/180-day rule calculations
├── test_auth_security.py    # Authentication and security
├── test_login.py            # Login functionality
├── conftest.py              # Pytest configuration and fixtures
└── ...
```

### Running Specific Test Suites

**All tests:**
```bash
pytest tests/ -v
```

**Specific test file:**
```bash
pytest tests/test_rolling90.py -v
```

**Specific test function:**
```bash
pytest tests/test_rolling90.py::test_days_used_in_window -v
```

**With coverage:**
```bash
pytest tests/ --cov=app --cov-report=html
```

### Test Categories

**Unit Tests:**
- 90/180-day rule calculations
- Date validation
- Country code validation
- Password hashing
- Data export functions

**Integration Tests:**
- Database operations (CRUD)
- Authentication flow
- Session management
- API endpoints
- Excel import/export

### Test Configuration

Tests use an in-memory SQLite database by default (configured in `conftest.py`). This ensures:
- Fast test execution
- No database file pollution
- Isolated test runs
- Parallel test execution support

---

## Playwright Test Suite

### Test Structure

```
tests/
├── calendar.spec.js         # Calendar functionality
├── excel_import.spec.js     # Excel import flows
├── excel_display.spec.js    # Dashboard rendering
├── excel_data_validation.spec.js  # Data validation
├── excel_security.spec.js   # Security and GDPR
└── global.setup.ts          # Test setup and authentication
```

### Running Playwright Tests

**All tests:**
```bash
npm run test:qa
# or
npx playwright test
```

**Specific test file:**
```bash
npx playwright test tests/calendar.spec.js
```

**With UI mode (interactive):**
```bash
npx playwright test --ui
```

**In headed mode (see browser):**
```bash
npx playwright test --headed
```

**Specific browser:**
```bash
npx playwright test --project=chromium
npx playwright test --project=firefox
npx playwright test --project=webkit
```

### Playwright Configuration

Configuration is in `playwright.config.js`:
- Base URL: `http://localhost:5000`
- Test timeout: 30 seconds
- Retries: 2 on failure
- Screenshots on failure
- Video recording on failure

### Test Authentication

Playwright tests use authenticated session state stored in `tests/auth/state.json`. This is automatically generated by `tests/global.setup.ts`.

**Regenerate authentication state:**
```bash
npx playwright test tests/global.setup.ts
```

---

## Excel Import Tests

### Running Excel Tests

```bash
npm run test:excel
# or
bash scripts/run_excel_tests.sh
```

This command:
1. Generates fresh test workbooks in `tests/sample_files/`
2. Resets the isolated Playwright database
3. Executes all Excel import test suites
4. Validates data integrity

### Test Files

- `tests/excel_import.spec.js` - File upload flows and error handling
- `tests/excel_display.spec.js` - Dashboard/calendar rendering verification
- `tests/excel_data_validation.spec.js` - Importer assertions via Python helpers
- `tests/excel_security.spec.js` - GDPR/privacy and DSAR coverage

---

## Test Reports

### Python Test Reports

**HTML coverage report:**
```bash
pytest tests/ --cov=app --cov-report=html
# Open htmlcov/index.html in browser
```

**JSON report:**
```bash
pytest tests/ --json-report --json-report-file=test_report.json
```

### Playwright Test Reports

**HTML report:**
```bash
npx playwright show-report
```

**JSON report:**
```bash
npx playwright test --reporter=json
```

Reports are saved in:
- `playwright-report/` - HTML reports
- `test-results/` - Screenshots and videos
- `reports/` - Test summaries

---

## Continuous Integration

### GitHub Actions Example

```yaml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: pip install -r requirements.txt
      - run: npm install
      - run: npx playwright install --with-deps
      - run: pytest tests/ -v
      - run: npx playwright test
```

---

## Writing New Tests

### Python Test Example

```python
import pytest
from app.services.rolling90 import days_used_in_window

def test_days_used_in_window():
    trips = [
        {'entry_date': '2024-01-01', 'exit_date': '2024-01-10'},
    ]
    presence = presence_days(trips)
    result = days_used_in_window(presence, date(2024, 1, 15))
    assert result == 10
```

### Playwright Test Example

```javascript
import { test, expect } from '@playwright/test';

test('should add a new employee', async ({ page }) => {
  await page.goto('/dashboard');
  await page.click('text=Add Employee');
  await page.fill('input[name="name"]', 'Test Employee');
  await page.click('button[type="submit"]');
  await expect(page.locator('text=Test Employee')).toBeVisible();
});
```

---

## Test Maintenance

### Updating Test Data

Test fixtures are in:
- `tests/fixtures/` - Sample data files
- `tests/sample_files/` - Excel test workbooks
- `data/fixtures/` - Database fixtures

### Debugging Failed Tests

**Python:**
```bash
pytest tests/test_rolling90.py -v -s  # Show print statements
pytest tests/test_rolling90.py --pdb   # Drop into debugger on failure
```

**Playwright:**
```bash
npx playwright test --debug             # Step through test
npx playwright test --headed --debug    # See browser + debug
```

### Test Best Practices

1. **Isolation**: Each test should be independent
2. **Cleanup**: Tests should clean up after themselves
3. **Naming**: Use descriptive test names
4. **Speed**: Keep tests fast (use in-memory DB)
5. **Coverage**: Aim for >80% code coverage

---

## Known Issues

### Common Test Failures

**Issue**: `Database locked`
- **Solution**: Ensure no other app instances are running

**Issue**: `Port 5000 already in use`
- **Solution**: Kill process using port 5000 or change port in config

**Issue**: `Playwright browser not found`
- **Solution**: Run `npx playwright install`

**Issue**: `Authentication state expired`
- **Solution**: Regenerate state: `npx playwright test tests/global.setup.ts`

---

## Test Coverage Goals

- **Core Logic**: 95%+ (rolling90, validators)
- **API Endpoints**: 80%+ (routes, authentication)
- **UI Components**: 70%+ (critical paths)
- **Overall**: 80%+ code coverage

---

## Additional Resources

- `docs/testing/` - Detailed test documentation
- `reports/` - Test execution reports
- `playwright-report/` - Playwright HTML reports
- `docs/notes/post_phase1_reflection.md` - Test stability notes

---

**Testing Complete!** ✅

For questions or issues, refer to:
- `README.md` - Project overview
- `docs/` - Additional documentation
- Test output and error messages

